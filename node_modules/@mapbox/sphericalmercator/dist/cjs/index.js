"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SphericalMercator = void 0;
const constants_js_1 = require("./constants.js");
const cache = {};
function isFloat(n) {
    return Number(n) === n && n % 1 !== 0;
}
class SphericalMercator {
    #size;
    #expansion;
    #Bc;
    #Cc;
    #zc;
    #Ac;
    constructor(options = {}) {
        this.#size = options.size || 256;
        this.#expansion = options.antimeridian ? 2 : 1;
        if (!cache[this.#size]) {
            let size = this.#size;
            const c = (cache[this.#size] = {});
            c.Bc = [];
            c.Cc = [];
            c.zc = [];
            c.Ac = [];
            for (let d = 0; d < 30; d++) {
                c.Bc.push(size / 360);
                c.Cc.push(size / (2 * Math.PI));
                c.zc.push(size / 2);
                c.Ac.push(size);
                size *= 2;
            }
        }
        this.#Bc = cache[this.#size].Bc;
        this.#Cc = cache[this.#size].Cc;
        this.#zc = cache[this.#size].zc;
        this.#Ac = cache[this.#size].Ac;
    }
    px(ll, zoom) {
        if (isFloat(zoom)) {
            const size = this.#size * Math.pow(2, zoom);
            const d = size / 2;
            const bc = size / 360;
            const cc = size / (2 * Math.PI);
            const ac = size;
            const f = Math.min(Math.max(Math.sin(constants_js_1.D2R * ll[1]), -0.9999), 0.9999);
            let x = d + ll[0] * bc;
            let y = d + 0.5 * Math.log((1 + f) / (1 - f)) * -cc;
            x > ac * this.#expansion && (x = ac * this.#expansion);
            y > ac && (y = ac);
            //(x < 0) && (x = 0);
            //(y < 0) && (y = 0);
            return [x, y];
        }
        else {
            const d = this.#zc[zoom];
            const f = Math.min(Math.max(Math.sin(constants_js_1.D2R * ll[1]), -0.9999), 0.9999);
            let x = Math.round(d + ll[0] * this.#Bc[zoom]);
            let y = Math.round(d + 0.5 * Math.log((1 + f) / (1 - f)) * -this.#Cc[zoom]);
            x > this.#Ac[zoom] * this.#expansion &&
                (x = this.#Ac[zoom] * this.#expansion);
            y > this.#Ac[zoom] && (y = this.#Ac[zoom]);
            //(x < 0) && (x = 0);
            //(y < 0) && (y = 0);
            return [x, y];
        }
    }
    ll(px, zoom) {
        if (isFloat(zoom)) {
            const size = this.#size * Math.pow(2, zoom);
            const bc = size / 360;
            const cc = size / (2 * Math.PI);
            const zc = size / 2;
            const g = (px[1] - zc) / -cc;
            const lon = (px[0] - zc) / bc;
            const lat = constants_js_1.R2D * (2 * Math.atan(Math.exp(g)) - 0.5 * Math.PI);
            return [lon, lat];
        }
        else {
            const g = (px[1] - this.#zc[zoom]) / -this.#Cc[zoom];
            const lon = (px[0] - this.#zc[zoom]) / this.#Bc[zoom];
            const lat = constants_js_1.R2D * (2 * Math.atan(Math.exp(g)) - 0.5 * Math.PI);
            return [lon, lat];
        }
    }
    convert(bbox, to) {
        if (to === constants_js_1.SPHERICAL_MERCATOR_SRS) {
            return [
                ...this.forward(bbox.slice(0, 2)),
                ...this.forward(bbox.slice(2, 4)),
            ];
        }
        else {
            return [
                ...this.inverse(bbox.slice(0, 2)),
                ...this.inverse(bbox.slice(2, 4)),
            ];
        }
    }
    inverse(xy) {
        return [
            (xy[0] * constants_js_1.R2D) / constants_js_1.A,
            (Math.PI * 0.5 - 2.0 * Math.atan(Math.exp(-xy[1] / constants_js_1.A))) * constants_js_1.R2D,
        ];
    }
    forward(ll) {
        const xy = [
            constants_js_1.A * ll[0] * constants_js_1.D2R,
            constants_js_1.A * Math.log(Math.tan(Math.PI * 0.25 + 0.5 * ll[1] * constants_js_1.D2R)),
        ];
        // if xy value is beyond maxextent (e.g. poles), return maxextent.
        xy[0] > constants_js_1.MAXEXTENT && (xy[0] = constants_js_1.MAXEXTENT);
        xy[0] < -constants_js_1.MAXEXTENT && (xy[0] = -constants_js_1.MAXEXTENT);
        xy[1] > constants_js_1.MAXEXTENT && (xy[1] = constants_js_1.MAXEXTENT);
        xy[1] < -constants_js_1.MAXEXTENT && (xy[1] = -constants_js_1.MAXEXTENT);
        return xy;
    }
    bbox(x, y, zoom, tmsStyle, srs) {
        // Convert xyz into bbox with srs WGS84
        if (tmsStyle) {
            y = Math.pow(2, zoom) - 1 - y;
        }
        // Use +y to make sure it's a number to avoid inadvertent concatenation.
        const ll = [x * this.#size, (+y + 1) * this.#size]; // lower left
        // Use +x to make sure it's a number to avoid inadvertent concatenation.
        const ur = [(+x + 1) * this.#size, y * this.#size]; // upper right
        const bbox = [...this.ll(ll, zoom), ...this.ll(ur, zoom)];
        // If web mercator requested reproject to 900913.
        if (srs === constants_js_1.SPHERICAL_MERCATOR_SRS)
            return this.convert(bbox, constants_js_1.SPHERICAL_MERCATOR_SRS);
        return bbox;
    }
    xyz(bbox, zoom, tmsStyle, srs) {
        // If web mercator provided reproject to WGS84.
        const box = srs === constants_js_1.SPHERICAL_MERCATOR_SRS ? this.convert(bbox, constants_js_1.WGS84) : bbox;
        const ll = [box[0], box[1]]; // lower left
        const ur = [box[2], box[3]]; // upper right
        const px_ll = this.px(ll, zoom);
        const px_ur = this.px(ur, zoom);
        // Y = 0 for XYZ is the top hence minY uses px_ur[1].
        const x = [
            Math.floor(px_ll[0] / this.#size),
            Math.floor((px_ur[0] - 1) / this.#size),
        ];
        const y = [
            Math.floor(px_ur[1] / this.#size),
            Math.floor((px_ll[1] - 1) / this.#size),
        ];
        const bounds = {
            minX: Math.min.apply(Math, x) < 0 ? 0 : Math.min.apply(Math, x),
            minY: Math.min.apply(Math, y) < 0 ? 0 : Math.min.apply(Math, y),
            maxX: Math.max.apply(Math, x),
            maxY: Math.max.apply(Math, y),
        };
        if (tmsStyle) {
            const tms = {
                minY: Math.pow(2, zoom) - 1 - bounds.maxY,
                maxY: Math.pow(2, zoom) - 1 - bounds.minY,
            };
            bounds.minY = tms.minY;
            bounds.maxY = tms.maxY;
        }
        return bounds;
    }
}
exports.SphericalMercator = SphericalMercator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaURBT3dCO0FBd0J4QixNQUFNLEtBQUssR0FBcUIsRUFBRSxDQUFDO0FBQ25DLFNBQVMsT0FBTyxDQUFDLENBQVM7SUFDeEIsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3hDLENBQUM7QUFFRCxNQUFhLGlCQUFpQjtJQUM1QixLQUFLLENBQVM7SUFDZCxVQUFVLENBQVE7SUFDbEIsR0FBRyxDQUFXO0lBQ2QsR0FBRyxDQUFXO0lBQ2QsR0FBRyxDQUFXO0lBQ2QsR0FBRyxDQUFXO0lBRWQsWUFBWSxVQUFtQixFQUFFO1FBQy9CLElBQUksQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUM7UUFDakMsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUUvQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3ZCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDdEIsTUFBTSxDQUFDLEdBQXFCLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNyRCxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUNWLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1lBQ1YsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7WUFDVixDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDNUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO2dCQUN0QixDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDcEIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2hCLElBQUksSUFBSSxDQUFDLENBQUM7WUFDWixDQUFDO1FBQ0gsQ0FBQztRQUNELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNoQyxJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVNLEVBQUUsQ0FBQyxFQUFVLEVBQUUsSUFBVTtRQUM5QixJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ2xCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDNUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNuQixNQUFNLEVBQUUsR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDaEMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO1lBQ2hCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGtCQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNyRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNwRCxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN2RCxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ25CLHFCQUFxQjtZQUNyQixxQkFBcUI7WUFDckIsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNoQixDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsa0JBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3JFLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDL0MsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FDaEIsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUN4RCxDQUFDO1lBQ0YsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVU7Z0JBQ2xDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3pDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMzQyxxQkFBcUI7WUFDckIscUJBQXFCO1lBQ3JCLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDaEIsQ0FBQztJQUNILENBQUM7SUFFTSxFQUFFLENBQUMsRUFBTSxFQUFFLElBQVU7UUFDMUIsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNsQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzVDLE1BQU0sRUFBRSxHQUFHLElBQUksR0FBRyxHQUFHLENBQUM7WUFDdEIsTUFBTSxFQUFFLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNoQyxNQUFNLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzdCLE1BQU0sR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUM5QixNQUFNLEdBQUcsR0FBRyxrQkFBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDL0QsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNwQixDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckQsTUFBTSxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEQsTUFBTSxHQUFHLEdBQUcsa0JBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9ELE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDcEIsQ0FBQztJQUNILENBQUM7SUFFTSxPQUFPLENBQUMsSUFBVSxFQUFFLEVBQU87UUFDaEMsSUFBSSxFQUFFLEtBQUsscUNBQXNCLEVBQUUsQ0FBQztZQUNsQyxPQUFPO2dCQUNMLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQVcsQ0FBQztnQkFDM0MsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBVyxDQUFDO2FBQzVDLENBQUM7UUFDSixDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU87Z0JBQ0wsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBTyxDQUFDO2dCQUN2QyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFPLENBQUM7YUFDeEMsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRU0sT0FBTyxDQUFDLEVBQU07UUFDbkIsT0FBTztZQUNMLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLGtCQUFHLENBQUMsR0FBRyxnQkFBQztZQUNqQixDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsZ0JBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxrQkFBRztTQUM5RCxDQUFDO0lBQ0osQ0FBQztJQUVNLE9BQU8sQ0FBQyxFQUFVO1FBQ3ZCLE1BQU0sRUFBRSxHQUFXO1lBQ2pCLGdCQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLGtCQUFHO1lBQ2YsZ0JBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxrQkFBRyxDQUFDLENBQUM7U0FDM0QsQ0FBQztRQUNGLGtFQUFrRTtRQUNsRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsd0JBQVMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyx3QkFBUyxDQUFDLENBQUM7UUFDekMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsd0JBQVMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLHdCQUFTLENBQUMsQ0FBQztRQUMzQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsd0JBQVMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyx3QkFBUyxDQUFDLENBQUM7UUFDekMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsd0JBQVMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLHdCQUFTLENBQUMsQ0FBQztRQUMzQyxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFTSxJQUFJLENBQ1QsQ0FBUyxFQUNULENBQVMsRUFDVCxJQUFVLEVBQ1YsUUFBa0IsRUFDbEIsR0FBWTtRQUVaLHVDQUF1QztRQUN2QyxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEMsQ0FBQztRQUNELHdFQUF3RTtRQUN4RSxNQUFNLEVBQUUsR0FBVyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYTtRQUN6RSx3RUFBd0U7UUFDeEUsTUFBTSxFQUFFLEdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGNBQWM7UUFDMUUsTUFBTSxJQUFJLEdBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVoRSxpREFBaUQ7UUFDakQsSUFBSSxHQUFHLEtBQUsscUNBQXNCO1lBQ2hDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUscUNBQXNCLENBQUMsQ0FBQztRQUVwRCxPQUFPLElBQVksQ0FBQztJQUN0QixDQUFDO0lBRU0sR0FBRyxDQUFDLElBQVUsRUFBRSxJQUFVLEVBQUUsUUFBa0IsRUFBRSxHQUFTO1FBQzlELCtDQUErQztRQUMvQyxNQUFNLEdBQUcsR0FDUCxHQUFHLEtBQUsscUNBQXNCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLG9CQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBRXBFLE1BQU0sRUFBRSxHQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYTtRQUNsRCxNQUFNLEVBQUUsR0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWM7UUFDbkQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEMscURBQXFEO1FBQ3JELE1BQU0sQ0FBQyxHQUFHO1lBQ1IsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7U0FDeEMsQ0FBQztRQUNGLE1BQU0sQ0FBQyxHQUFHO1lBQ1IsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7U0FDeEMsQ0FBQztRQUNGLE1BQU0sTUFBTSxHQUFHO1lBQ2IsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUMvRCxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQy9ELElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQzdCLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQzlCLENBQUM7UUFDRixJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsTUFBTSxHQUFHLEdBQUc7Z0JBQ1YsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSTtnQkFDekMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSTthQUMxQyxDQUFDO1lBQ0YsTUFBTSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ3ZCLE1BQU0sQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUN6QixDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGO0FBL0tELDhDQStLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEQyUixcbiAgUjJELFxuICBBLFxuICBNQVhFWFRFTlQsXG4gIFNQSEVSSUNBTF9NRVJDQVRPUl9TUlMsXG4gIFdHUzg0LFxufSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5cbmludGVyZmFjZSBPcHRpb25zIHtcbiAgc2l6ZT86IG51bWJlcjtcbiAgYW50aW1lcmlkaWFuPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIFhZWiB7XG4gIG1pblg6IG51bWJlcjtcbiAgbWF4WDogbnVtYmVyO1xuICBtaW5ZOiBudW1iZXI7XG4gIG1heFk6IG51bWJlcjtcbn1cblxudHlwZSBYWSA9IFtudW1iZXIsIG51bWJlcl07XG50eXBlIExvbkxhdCA9IFtudW1iZXIsIG51bWJlcl07XG50eXBlIFpvb20gPSBudW1iZXI7XG50eXBlIFdlc3QgPSBudW1iZXI7XG50eXBlIFNvdXRoID0gbnVtYmVyO1xudHlwZSBFYXN0ID0gbnVtYmVyO1xudHlwZSBOb3J0aCA9IG51bWJlcjtcbnR5cGUgQkJveCA9IFtXZXN0LCBTb3V0aCwgRWFzdCwgTm9ydGhdO1xudHlwZSBTUlMgPSB0eXBlb2YgU1BIRVJJQ0FMX01FUkNBVE9SX1NSUyB8IHR5cGVvZiBXR1M4NDtcblxuY29uc3QgY2FjaGU6IFJlY29yZDxhbnksIGFueT4gPSB7fTtcbmZ1bmN0aW9uIGlzRmxvYXQobjogbnVtYmVyKTogYm9vbGVhbiB7XG4gIHJldHVybiBOdW1iZXIobikgPT09IG4gJiYgbiAlIDEgIT09IDA7XG59XG5cbmV4cG9ydCBjbGFzcyBTcGhlcmljYWxNZXJjYXRvciB7XG4gICNzaXplOiBudW1iZXI7XG4gICNleHBhbnNpb246IDEgfCAyO1xuICAjQmM6IG51bWJlcltdO1xuICAjQ2M6IG51bWJlcltdO1xuICAjemM6IG51bWJlcltdO1xuICAjQWM6IG51bWJlcltdO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuI3NpemUgPSBvcHRpb25zLnNpemUgfHwgMjU2O1xuICAgIHRoaXMuI2V4cGFuc2lvbiA9IG9wdGlvbnMuYW50aW1lcmlkaWFuID8gMiA6IDE7XG5cbiAgICBpZiAoIWNhY2hlW3RoaXMuI3NpemVdKSB7XG4gICAgICBsZXQgc2l6ZSA9IHRoaXMuI3NpemU7XG4gICAgICBjb25zdCBjOiBSZWNvcmQ8YW55LCBhbnk+ID0gKGNhY2hlW3RoaXMuI3NpemVdID0ge30pO1xuICAgICAgYy5CYyA9IFtdO1xuICAgICAgYy5DYyA9IFtdO1xuICAgICAgYy56YyA9IFtdO1xuICAgICAgYy5BYyA9IFtdO1xuICAgICAgZm9yIChsZXQgZCA9IDA7IGQgPCAzMDsgZCsrKSB7XG4gICAgICAgIGMuQmMucHVzaChzaXplIC8gMzYwKTtcbiAgICAgICAgYy5DYy5wdXNoKHNpemUgLyAoMiAqIE1hdGguUEkpKTtcbiAgICAgICAgYy56Yy5wdXNoKHNpemUgLyAyKTtcbiAgICAgICAgYy5BYy5wdXNoKHNpemUpO1xuICAgICAgICBzaXplICo9IDI7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuI0JjID0gY2FjaGVbdGhpcy4jc2l6ZV0uQmM7XG4gICAgdGhpcy4jQ2MgPSBjYWNoZVt0aGlzLiNzaXplXS5DYztcbiAgICB0aGlzLiN6YyA9IGNhY2hlW3RoaXMuI3NpemVdLnpjO1xuICAgIHRoaXMuI0FjID0gY2FjaGVbdGhpcy4jc2l6ZV0uQWM7XG4gIH1cblxuICBwdWJsaWMgcHgobGw6IExvbkxhdCwgem9vbTogWm9vbSk6IFhZIHtcbiAgICBpZiAoaXNGbG9hdCh6b29tKSkge1xuICAgICAgY29uc3Qgc2l6ZSA9IHRoaXMuI3NpemUgKiBNYXRoLnBvdygyLCB6b29tKTtcbiAgICAgIGNvbnN0IGQgPSBzaXplIC8gMjtcbiAgICAgIGNvbnN0IGJjID0gc2l6ZSAvIDM2MDtcbiAgICAgIGNvbnN0IGNjID0gc2l6ZSAvICgyICogTWF0aC5QSSk7XG4gICAgICBjb25zdCBhYyA9IHNpemU7XG4gICAgICBjb25zdCBmID0gTWF0aC5taW4oTWF0aC5tYXgoTWF0aC5zaW4oRDJSICogbGxbMV0pLCAtMC45OTk5KSwgMC45OTk5KTtcbiAgICAgIGxldCB4ID0gZCArIGxsWzBdICogYmM7XG4gICAgICBsZXQgeSA9IGQgKyAwLjUgKiBNYXRoLmxvZygoMSArIGYpIC8gKDEgLSBmKSkgKiAtY2M7XG4gICAgICB4ID4gYWMgKiB0aGlzLiNleHBhbnNpb24gJiYgKHggPSBhYyAqIHRoaXMuI2V4cGFuc2lvbik7XG4gICAgICB5ID4gYWMgJiYgKHkgPSBhYyk7XG4gICAgICAvLyh4IDwgMCkgJiYgKHggPSAwKTtcbiAgICAgIC8vKHkgPCAwKSAmJiAoeSA9IDApO1xuICAgICAgcmV0dXJuIFt4LCB5XTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZCA9IHRoaXMuI3pjW3pvb21dO1xuICAgICAgY29uc3QgZiA9IE1hdGgubWluKE1hdGgubWF4KE1hdGguc2luKEQyUiAqIGxsWzFdKSwgLTAuOTk5OSksIDAuOTk5OSk7XG4gICAgICBsZXQgeCA9IE1hdGgucm91bmQoZCArIGxsWzBdICogdGhpcy4jQmNbem9vbV0pO1xuICAgICAgbGV0IHkgPSBNYXRoLnJvdW5kKFxuICAgICAgICBkICsgMC41ICogTWF0aC5sb2coKDEgKyBmKSAvICgxIC0gZikpICogLXRoaXMuI0NjW3pvb21dLFxuICAgICAgKTtcbiAgICAgIHggPiB0aGlzLiNBY1t6b29tXSAqIHRoaXMuI2V4cGFuc2lvbiAmJlxuICAgICAgICAoeCA9IHRoaXMuI0FjW3pvb21dICogdGhpcy4jZXhwYW5zaW9uKTtcbiAgICAgIHkgPiB0aGlzLiNBY1t6b29tXSAmJiAoeSA9IHRoaXMuI0FjW3pvb21dKTtcbiAgICAgIC8vKHggPCAwKSAmJiAoeCA9IDApO1xuICAgICAgLy8oeSA8IDApICYmICh5ID0gMCk7XG4gICAgICByZXR1cm4gW3gsIHldO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBsbChweDogWFksIHpvb206IFpvb20pOiBMb25MYXQge1xuICAgIGlmIChpc0Zsb2F0KHpvb20pKSB7XG4gICAgICBjb25zdCBzaXplID0gdGhpcy4jc2l6ZSAqIE1hdGgucG93KDIsIHpvb20pO1xuICAgICAgY29uc3QgYmMgPSBzaXplIC8gMzYwO1xuICAgICAgY29uc3QgY2MgPSBzaXplIC8gKDIgKiBNYXRoLlBJKTtcbiAgICAgIGNvbnN0IHpjID0gc2l6ZSAvIDI7XG4gICAgICBjb25zdCBnID0gKHB4WzFdIC0gemMpIC8gLWNjO1xuICAgICAgY29uc3QgbG9uID0gKHB4WzBdIC0gemMpIC8gYmM7XG4gICAgICBjb25zdCBsYXQgPSBSMkQgKiAoMiAqIE1hdGguYXRhbihNYXRoLmV4cChnKSkgLSAwLjUgKiBNYXRoLlBJKTtcbiAgICAgIHJldHVybiBbbG9uLCBsYXRdO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBnID0gKHB4WzFdIC0gdGhpcy4jemNbem9vbV0pIC8gLXRoaXMuI0NjW3pvb21dO1xuICAgICAgY29uc3QgbG9uID0gKHB4WzBdIC0gdGhpcy4jemNbem9vbV0pIC8gdGhpcy4jQmNbem9vbV07XG4gICAgICBjb25zdCBsYXQgPSBSMkQgKiAoMiAqIE1hdGguYXRhbihNYXRoLmV4cChnKSkgLSAwLjUgKiBNYXRoLlBJKTtcbiAgICAgIHJldHVybiBbbG9uLCBsYXRdO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjb252ZXJ0KGJib3g6IEJCb3gsIHRvOiBTUlMpOiBCQm94IHtcbiAgICBpZiAodG8gPT09IFNQSEVSSUNBTF9NRVJDQVRPUl9TUlMpIHtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIC4uLnRoaXMuZm9yd2FyZChiYm94LnNsaWNlKDAsIDIpIGFzIExvbkxhdCksXG4gICAgICAgIC4uLnRoaXMuZm9yd2FyZChiYm94LnNsaWNlKDIsIDQpIGFzIExvbkxhdCksXG4gICAgICBdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gW1xuICAgICAgICAuLi50aGlzLmludmVyc2UoYmJveC5zbGljZSgwLCAyKSBhcyBYWSksXG4gICAgICAgIC4uLnRoaXMuaW52ZXJzZShiYm94LnNsaWNlKDIsIDQpIGFzIFhZKSxcbiAgICAgIF07XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGludmVyc2UoeHk6IFhZKTogTG9uTGF0IHtcbiAgICByZXR1cm4gW1xuICAgICAgKHh5WzBdICogUjJEKSAvIEEsXG4gICAgICAoTWF0aC5QSSAqIDAuNSAtIDIuMCAqIE1hdGguYXRhbihNYXRoLmV4cCgteHlbMV0gLyBBKSkpICogUjJELFxuICAgIF07XG4gIH1cblxuICBwdWJsaWMgZm9yd2FyZChsbDogTG9uTGF0KTogWFkge1xuICAgIGNvbnN0IHh5OiBMb25MYXQgPSBbXG4gICAgICBBICogbGxbMF0gKiBEMlIsXG4gICAgICBBICogTWF0aC5sb2coTWF0aC50YW4oTWF0aC5QSSAqIDAuMjUgKyAwLjUgKiBsbFsxXSAqIEQyUikpLFxuICAgIF07XG4gICAgLy8gaWYgeHkgdmFsdWUgaXMgYmV5b25kIG1heGV4dGVudCAoZS5nLiBwb2xlcyksIHJldHVybiBtYXhleHRlbnQuXG4gICAgeHlbMF0gPiBNQVhFWFRFTlQgJiYgKHh5WzBdID0gTUFYRVhURU5UKTtcbiAgICB4eVswXSA8IC1NQVhFWFRFTlQgJiYgKHh5WzBdID0gLU1BWEVYVEVOVCk7XG4gICAgeHlbMV0gPiBNQVhFWFRFTlQgJiYgKHh5WzFdID0gTUFYRVhURU5UKTtcbiAgICB4eVsxXSA8IC1NQVhFWFRFTlQgJiYgKHh5WzFdID0gLU1BWEVYVEVOVCk7XG4gICAgcmV0dXJuIHh5O1xuICB9XG5cbiAgcHVibGljIGJib3goXG4gICAgeDogbnVtYmVyLFxuICAgIHk6IG51bWJlcixcbiAgICB6b29tOiBab29tLFxuICAgIHRtc1N0eWxlPzogYm9vbGVhbixcbiAgICBzcnM/OiBzdHJpbmcsXG4gICk6IEJCb3gge1xuICAgIC8vIENvbnZlcnQgeHl6IGludG8gYmJveCB3aXRoIHNycyBXR1M4NFxuICAgIGlmICh0bXNTdHlsZSkge1xuICAgICAgeSA9IE1hdGgucG93KDIsIHpvb20pIC0gMSAtIHk7XG4gICAgfVxuICAgIC8vIFVzZSAreSB0byBtYWtlIHN1cmUgaXQncyBhIG51bWJlciB0byBhdm9pZCBpbmFkdmVydGVudCBjb25jYXRlbmF0aW9uLlxuICAgIGNvbnN0IGxsOiBMb25MYXQgPSBbeCAqIHRoaXMuI3NpemUsICgreSArIDEpICogdGhpcy4jc2l6ZV07IC8vIGxvd2VyIGxlZnRcbiAgICAvLyBVc2UgK3ggdG8gbWFrZSBzdXJlIGl0J3MgYSBudW1iZXIgdG8gYXZvaWQgaW5hZHZlcnRlbnQgY29uY2F0ZW5hdGlvbi5cbiAgICBjb25zdCB1cjogTG9uTGF0ID0gWygreCArIDEpICogdGhpcy4jc2l6ZSwgeSAqIHRoaXMuI3NpemVdOyAvLyB1cHBlciByaWdodFxuICAgIGNvbnN0IGJib3g6IEJCb3ggPSBbLi4udGhpcy5sbChsbCwgem9vbSksIC4uLnRoaXMubGwodXIsIHpvb20pXTtcblxuICAgIC8vIElmIHdlYiBtZXJjYXRvciByZXF1ZXN0ZWQgcmVwcm9qZWN0IHRvIDkwMDkxMy5cbiAgICBpZiAoc3JzID09PSBTUEhFUklDQUxfTUVSQ0FUT1JfU1JTKVxuICAgICAgcmV0dXJuIHRoaXMuY29udmVydChiYm94LCBTUEhFUklDQUxfTUVSQ0FUT1JfU1JTKTtcblxuICAgIHJldHVybiBiYm94IGFzIEJCb3g7XG4gIH1cblxuICBwdWJsaWMgeHl6KGJib3g6IEJCb3gsIHpvb206IFpvb20sIHRtc1N0eWxlPzogYm9vbGVhbiwgc3JzPzogU1JTKTogWFlaIHtcbiAgICAvLyBJZiB3ZWIgbWVyY2F0b3IgcHJvdmlkZWQgcmVwcm9qZWN0IHRvIFdHUzg0LlxuICAgIGNvbnN0IGJveCA9XG4gICAgICBzcnMgPT09IFNQSEVSSUNBTF9NRVJDQVRPUl9TUlMgPyB0aGlzLmNvbnZlcnQoYmJveCwgV0dTODQpIDogYmJveDtcblxuICAgIGNvbnN0IGxsOiBMb25MYXQgPSBbYm94WzBdLCBib3hbMV1dOyAvLyBsb3dlciBsZWZ0XG4gICAgY29uc3QgdXI6IExvbkxhdCA9IFtib3hbMl0sIGJveFszXV07IC8vIHVwcGVyIHJpZ2h0XG4gICAgY29uc3QgcHhfbGwgPSB0aGlzLnB4KGxsLCB6b29tKTtcbiAgICBjb25zdCBweF91ciA9IHRoaXMucHgodXIsIHpvb20pO1xuICAgIC8vIFkgPSAwIGZvciBYWVogaXMgdGhlIHRvcCBoZW5jZSBtaW5ZIHVzZXMgcHhfdXJbMV0uXG4gICAgY29uc3QgeCA9IFtcbiAgICAgIE1hdGguZmxvb3IocHhfbGxbMF0gLyB0aGlzLiNzaXplKSxcbiAgICAgIE1hdGguZmxvb3IoKHB4X3VyWzBdIC0gMSkgLyB0aGlzLiNzaXplKSxcbiAgICBdO1xuICAgIGNvbnN0IHkgPSBbXG4gICAgICBNYXRoLmZsb29yKHB4X3VyWzFdIC8gdGhpcy4jc2l6ZSksXG4gICAgICBNYXRoLmZsb29yKChweF9sbFsxXSAtIDEpIC8gdGhpcy4jc2l6ZSksXG4gICAgXTtcbiAgICBjb25zdCBib3VuZHMgPSB7XG4gICAgICBtaW5YOiBNYXRoLm1pbi5hcHBseShNYXRoLCB4KSA8IDAgPyAwIDogTWF0aC5taW4uYXBwbHkoTWF0aCwgeCksXG4gICAgICBtaW5ZOiBNYXRoLm1pbi5hcHBseShNYXRoLCB5KSA8IDAgPyAwIDogTWF0aC5taW4uYXBwbHkoTWF0aCwgeSksXG4gICAgICBtYXhYOiBNYXRoLm1heC5hcHBseShNYXRoLCB4KSxcbiAgICAgIG1heFk6IE1hdGgubWF4LmFwcGx5KE1hdGgsIHkpLFxuICAgIH07XG4gICAgaWYgKHRtc1N0eWxlKSB7XG4gICAgICBjb25zdCB0bXMgPSB7XG4gICAgICAgIG1pblk6IE1hdGgucG93KDIsIHpvb20pIC0gMSAtIGJvdW5kcy5tYXhZLFxuICAgICAgICBtYXhZOiBNYXRoLnBvdygyLCB6b29tKSAtIDEgLSBib3VuZHMubWluWSxcbiAgICAgIH07XG4gICAgICBib3VuZHMubWluWSA9IHRtcy5taW5ZO1xuICAgICAgYm91bmRzLm1heFkgPSB0bXMubWF4WTtcbiAgICB9XG5cbiAgICByZXR1cm4gYm91bmRzO1xuICB9XG59XG4iXX0=