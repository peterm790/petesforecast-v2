import{d as y,l as E,i as Re,T as ht,a as Lt,b as kt,c as It,e as xe,f as Le,P as ke,R as X,s as At,I as bt,W as Ie,m as Dt,g as Ae,w as Ot,p as se,h as ne,V as rt,C as De,j as re,M as ot,k as Oe,S as Ve,n as ze,L as oe,o as ae,q,r as Fe,t as Vt,u as N,v as he,E as pt,x as Ne,y as zt,z as st,A as Ue,B as je,D as ct,F as Be,G as Ge,H as We,J as He,K as Ze,N as qe,O as $e,Q as Xe}from"./deep-equal-D6CKYaOP.js";import{i as Ye,a as ce,r as Ke,b as Je,D as et,l as Qe,S as Pt,c as ti,d as ft,f as W,L as B,T as ei,e as S,g as ii,W as Y,h as si,j as ni}from"./webgl-device-hXSGq3cL.js";import{P as le}from"./pick-layers-pass-BfkXGi0f.js";const ri="4.3.3",oi=globalThis.loaders?.parseImageNode,gt=typeof Image<"u",mt=typeof ImageBitmap<"u",ai=!!oi,wt=Ye?!0:ai;function hi(r){switch(r){case"auto":return mt||gt||wt;case"imagebitmap":return mt;case"image":return gt;case"data":return wt;default:throw new Error(`@loaders.gl/images: image ${r} not supported in this environment`)}}function ci(){if(mt)return"imagebitmap";if(gt)return"image";if(wt)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function li(r){const t=ui(r);if(!t)throw new Error("Not an image");return t}function di(r){switch(li(r)){case"data":return r;case"image":case"imagebitmap":const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("getImageData");return t.width=r.width,t.height=r.height,e.drawImage(r,0,0),e.getImageData(0,0,r.width,r.height);default:throw new Error("getImageData")}}function ui(r){return typeof ImageBitmap<"u"&&r instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&r instanceof Image?"image":r&&typeof r=="object"&&r.data&&r.width&&r.height?"data":null}const pi=/^data:image\/svg\+xml/,fi=/\.svg((\?|#).*)?$/;function St(r){return r&&(pi.test(r)||fi.test(r))}function gi(r,t){if(St(t)){let i=new TextDecoder().decode(r);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(n){throw new Error(n.message)}return`data:image/svg+xml;base64,${btoa(i)}`}return de(r,t)}function de(r,t){if(St(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(r)])}async function ue(r,t,e){const i=gi(r,e),s=self.URL||self.webkitURL,n=typeof i!="string"&&s.createObjectURL(i);try{return await mi(n||i,t)}finally{n&&s.revokeObjectURL(n)}}async function mi(r,t){const e=new Image;return e.src=r,t.image&&t.image.decode&&e.decode?(await e.decode(),e):await new Promise((i,s)=>{try{e.onload=()=>i(e),e.onerror=n=>{const o=n instanceof Error?n.message:"error";s(new Error(o))}}catch(n){s(n)}})}const wi={};let Ft=!0;async function _i(r,t,e){let i;St(e)?i=await ue(r,t,e):i=de(r,e);const s=t&&t.imagebitmap;return await vi(i,s)}async function vi(r,t=null){if((yi(t)||!Ft)&&(t=null),t)try{return await createImageBitmap(r,t)}catch(e){console.warn(e),Ft=!1}return await createImageBitmap(r)}function yi(r){for(const t in r||wi)return!1;return!0}function Ei(r){return!Mi(r,"ftyp",4)||(r[8]&96)===0?null:bi(r)}function bi(r){switch(Pi(r,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function Pi(r,t,e){return String.fromCharCode(...r.slice(t,e))}function Si(r){return[...r].map(t=>t.charCodeAt(0))}function Mi(r,t,e=0){const i=Si(t);for(let s=0;s<i.length;++s)if(i[s]!==r[s+e])return!1;return!0}const M=!1,G=!0;function pe(r){const t=$(r);return Ci(t)||Li(t)||Ri(t)||xi(t)||Ti(t)}function Ti(r){const t=new Uint8Array(r instanceof DataView?r.buffer:r),e=Ei(t);return e?{mimeType:e.mimeType,width:0,height:0}:null}function Ci(r){const t=$(r);return t.byteLength>=24&&t.getUint32(0,M)===2303741511?{mimeType:"image/png",width:t.getUint32(16,M),height:t.getUint32(20,M)}:null}function Ri(r){const t=$(r);return t.byteLength>=10&&t.getUint32(0,M)===1195984440?{mimeType:"image/gif",width:t.getUint16(6,G),height:t.getUint16(8,G)}:null}function xi(r){const t=$(r);return t.byteLength>=14&&t.getUint16(0,M)===16973&&t.getUint32(2,G)===t.byteLength?{mimeType:"image/bmp",width:t.getUint32(18,G),height:t.getUint32(22,G)}:null}function Li(r){const t=$(r);if(!(t.byteLength>=3&&t.getUint16(0,M)===65496&&t.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:s}=ki();let n=2;for(;n+9<t.byteLength;){const o=t.getUint16(n,M);if(s.has(o))return{mimeType:"image/jpeg",height:t.getUint16(n+5,M),width:t.getUint16(n+7,M)};if(!i.has(o))return null;n+=2,n+=t.getUint16(n,M)}return null}function ki(){const r=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)r.add(e);return{tableMarkers:r,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function $(r){if(r instanceof DataView)return r;if(ArrayBuffer.isView(r))return new DataView(r.buffer);if(r instanceof ArrayBuffer)return new DataView(r);throw new Error("toDataView")}async function Ii(r,t){const{mimeType:e}=pe(r)||{},i=globalThis.loaders?.parseImageNode;return ce(i),await i(r,e)}async function Ai(r,t,e){t=t||{};const s=(t.image||{}).type||"auto",{url:n}=e||{},o=Di(s);let a;switch(o){case"imagebitmap":a=await _i(r,t,n);break;case"image":a=await ue(r,t,n);break;case"data":a=await Ii(r);break;default:ce(!1)}return s==="data"&&(a=di(a)),a}function Di(r){switch(r){case"auto":case"data":return ci();default:return hi(r),r}}const Oi=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],Vi=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],zi={image:{type:"auto",decode:!0}},Fi={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:ri,mimeTypes:Vi,extensions:Oi,parse:Ai,tests:[r=>!!pe(new DataView(r))],options:zi};function Ni(r){const t=r[0],e=r[r.length-1];return t==="{"&&e==="}"||t==="["&&e==="]"}const Ui={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:Ni,parseTextSync:JSON.parse};function ji(){const r="9.1.12",t=globalThis.deck&&globalThis.deck.VERSION;if(t&&t!==r)throw new Error(`deck.gl - multiple versions detected: ${t} vs ${r}`);return t||(y.log(1,`deck.gl ${r}`)(),globalThis.deck={...globalThis.deck,VERSION:r,version:r,log:y,_registerLoggers:Ke},Je([Ui,[Fi,{imagebitmap:{premultiplyAlpha:"none"}}]])),r}const Bi=ji(),Gi=Re()&&typeof document<"u",Wi=()=>Gi&&document.readyState==="complete",Hi="set luma.log.level=1 (or higher) to trace rendering",Nt="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class U{static defaultProps={...et.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};static pageLoaded=Zi().then(()=>{E.probe(2,"DOM is loaded")()});stats=Qe;log=E;VERSION="9.1.9";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw E.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),E.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");E.error("This version of luma.gl has already been initialized")()}E.log(1,`${this.VERSION} - ${Hi}`)(),globalThis.luma=this}registerAdapters(t){for(const e of t)this.preregisteredAdapters.set(e.type,e)}getSupportedAdapters(t=[]){const e=this.getAdapterMap(t);return Array.from(e).map(([,i])=>i).filter(i=>i.isSupported?.()).map(i=>i.type)}getBestAvailableAdapter(t=[]){const e=this.getAdapterMap(t);return e.get("webgpu")?.isSupported?.()?"webgpu":e.get("webgl")?.isSupported?.()?"webgl":null}setDefaultDeviceProps(t){Object.assign(U.defaultProps,t)}async createDevice(t={}){t={...U.defaultProps,...t},t.waitForPageLoad&&await U.pageLoaded;const e=this.getAdapterMap(t.adapters);let i=t.type||"";i==="best-available"&&(i=this.getBestAvailableAdapter(t.adapters)||i);const o=await(this.getAdapterMap(t.adapters)||e).get(i)?.create?.(t);if(o)return o;throw new Error(Nt)}async attachDevice(t){const e=this.getAdapterMap(t.adapters);let i="";t.handle instanceof WebGL2RenderingContext&&(i="webgl"),t.createCanvasContext&&await U.pageLoaded,t.handle===null&&(i="unknown");const n=await e.get(i)?.attach?.(null);if(n)return n;throw new Error(Nt)}enforceWebGL2(t=!0,e=[]){const s=this.getAdapterMap(e).get("webgl");s||E.warn("enforceWebGL2: webgl adapter not found")(),s?.enforceWebGL2?.(t)}getAdapterMap(t=[]){const e=new Map(this.preregisteredAdapters);for(const i of t)e.set(i.type,i);return e}registerDevices(t){E.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const e of t){const i=e.adapter;i&&this.preregisteredAdapters.set(i.type,i)}}}const _t=new U;function Zi(){return Wi()||typeof window>"u"?Promise.resolve():new Promise(r=>{window.addEventListener("load",()=>r())})}class qi{}const Ut=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,$i={name:"layer",vs:Ut,fs:Ut,getUniforms:r=>({opacity:Math.pow(r.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}};function Xi(r){if(r.includes(ht))return ht;const t=r.includes(Lt),e=r.includes(kt);return t&&e?ht:t||e?t?Lt:kt:r.includes(It)?It:xe}class Yi{constructor(t,e){this.actions="",this.manager=t,this.set(e)}set(t){t===Le&&(t=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=t,this.actions=t)}update(){this.set(this.manager.options.touchAction)}compute(){let t=[];for(const e of this.manager.recognizers)e.options.enable&&(t=t.concat(e.getTouchAction()));return Xi(t.join(" "))}}const Ki=["","webkit","Moz","MS","ms","o"];function Ji(r,t){const e=t[0].toUpperCase()+t.slice(1);for(const i of Ki){const s=i?i+e:t;if(s in r)return s}}const Qi=1,jt=2,Bt={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class ts{constructor(t,e){this.options={...Bt,...e,cssProps:{...Bt.cssProps,...e.cssProps},inputTarget:e.inputTarget||t},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=t,this.input=new ke(this),this.touchAction=new Yi(this,this.options.touchAction),this.toggleCssProps(!0)}set(t){return Object.assign(this.options,t),t.touchAction&&this.touchAction.update(),t.inputTarget&&(this.input.destroy(),this.input.target=t.inputTarget,this.input.init()),this}stop(t){this.session.stopped=t?jt:Qi}recognize(t){const{session:e}=this;if(e.stopped)return;this.session.prevented&&t.srcEvent.preventDefault();let i;const{recognizers:s}=this;let{curRecognizer:n}=e;(!n||n&&n.state&X.Recognized)&&(n=e.curRecognizer=null);let o=0;for(;o<s.length;)i=s[o],e.stopped!==jt&&(!n||i===n||i.canRecognizeWith(n))?i.recognize(t):i.reset(),!n&&i.state&(X.Began|X.Changed|X.Ended)&&(n=e.curRecognizer=i),o++}get(t){const{recognizers:e}=this;for(let i=0;i<e.length;i++)if(e[i].options.event===t)return e[i];return null}add(t){if(Array.isArray(t)){for(const i of t)this.add(i);return this}const e=this.get(t.options.event);return e&&this.remove(e),this.recognizers.push(t),t.manager=this,this.touchAction.update(),t}remove(t){if(Array.isArray(t)){for(const i of t)this.remove(i);return this}const e=typeof t=="string"?this.get(t):t;if(e){const{recognizers:i}=this,s=i.indexOf(e);s!==-1&&(i.splice(s,1),this.touchAction.update())}return this}on(t,e){if(!t||!e)return;const{handlers:i}=this;for(const s of At(t))i[s]=i[s]||[],i[s].push(e)}off(t,e){if(!t)return;const{handlers:i}=this;for(const s of At(t))e?i[s]&&i[s].splice(i[s].indexOf(e),1):delete i[s]}emit(t,e){const i=this.handlers[t]&&this.handlers[t].slice();if(!i||!i.length)return;const s=e;s.type=t,s.preventDefault=function(){e.srcEvent.preventDefault()};let n=0;for(;n<i.length;)i[n](s),n++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(t){const{element:e}=this;if(e){for(const[i,s]of Object.entries(this.options.cssProps)){const n=Ji(e.style,i);t?(this.oldCssProps[n]=e.style[n],e.style[n]=s):e.style[n]=this.oldCssProps[n]||""}t||(this.oldCssProps={})}}}const Gt=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class es extends bt{constructor(t,e,i){super(t,e,{enable:!0,...i}),this.handleEvent=n=>{this.handleOverEvent(n),this.handleOutEvent(n),this.handleEnterEvent(n),this.handleLeaveEvent(n),this.handleMoveEvent(n)},this.pressed=!1;const{enable:s}=this.options;this.enableMoveEvent=s,this.enableLeaveEvent=s,this.enableEnterEvent=s,this.enableOutEvent=s,this.enableOverEvent=s,Gt.forEach(n=>t.addEventListener(n,this.handleEvent))}destroy(){Gt.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){switch(t){case"pointermove":this.enableMoveEvent=e;break;case"pointerover":this.enableOverEvent=e;break;case"pointerout":this.enableOutEvent=e;break;case"pointerenter":this.enableEnterEvent=e;break;case"pointerleave":this.enableLeaveEvent=e;break}}handleOverEvent(t){this.enableOverEvent&&t.type==="mouseover"&&this._emit("pointerover",t)}handleOutEvent(t){this.enableOutEvent&&t.type==="mouseout"&&this._emit("pointerout",t)}handleEnterEvent(t){this.enableEnterEvent&&t.type==="mouseenter"&&this._emit("pointerenter",t)}handleLeaveEvent(t){this.enableLeaveEvent&&t.type==="mouseleave"&&this._emit("pointerleave",t)}handleMoveEvent(t){if(this.enableMoveEvent)switch(t.type){case"mousedown":t.button>=0&&(this.pressed=!0);break;case"mousemove":t.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",t);break;case"mouseup":this.pressed=!1;break}}_emit(t,e){this.callback({type:t,center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})}}const Wt=["keydown","keyup"];class is extends bt{constructor(t,e,i){super(t,e,{enable:!0,tabIndex:0,...i}),this.handleEvent=s=>{const n=s.target||s.srcElement;n.tagName==="INPUT"&&n.type==="text"||n.tagName==="TEXTAREA"||(this.enableDownEvent&&s.type==="keydown"&&this.callback({type:"keydown",srcEvent:s,key:s.key,target:s.target}),this.enableUpEvent&&s.type==="keyup"&&this.callback({type:"keyup",srcEvent:s,key:s.key,target:s.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,t.tabIndex=this.options.tabIndex,t.style.outline="none",Wt.forEach(s=>t.addEventListener(s,this.handleEvent))}destroy(){Wt.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t==="keydown"&&(this.enableDownEvent=e),t==="keyup"&&(this.enableUpEvent=e)}}class ss extends bt{constructor(t,e,i){super(t,e,i),this.handleEvent=s=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:s.clientX,y:s.clientY},srcEvent:s,pointerType:"mouse",target:s.target})},t.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(t,e){t==="contextmenu"&&(this.options.enable=e)}}const Ht=1,vt=2,Zt=4,ns={pointerdown:Ht,pointermove:vt,pointerup:Zt,mousedown:Ht,mousemove:vt,mouseup:Zt},rs=0,os=1,as=2,hs=1,cs=2,ls=4;function ds(r){const t=ns[r.srcEvent.type];if(!t)return null;const{buttons:e,button:i}=r.srcEvent;let s=!1,n=!1,o=!1;return t===vt?(s=!!(e&hs),n=!!(e&ls),o=!!(e&cs)):(s=i===rs,n=i===os,o=i===as),{leftButton:s,middleButton:n,rightButton:o}}function us(r,t){const e=r.center;if(!e)return null;const i=t.getBoundingClientRect(),s=i.width/t.offsetWidth||1,n=i.height/t.offsetHeight||1,o={x:(e.x-i.left-t.clientLeft)/s,y:(e.y-i.top-t.clientTop)/n};return{center:e,offsetCenter:o}}const ps={srcElement:"root",priority:0};class fs{constructor(t,e){this.handleEvent=i=>{if(this.isEmpty())return;const s=this._normalizeEvent(i);let n=i.srcEvent.target;for(;n&&n!==s.rootElement;){if(this._emit(s,n),s.handled)return;n=n.parentNode}this._emit(s,"root")},this.eventManager=t,this.recognizerName=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(t,e,i,s=!1,n=!1){const{handlers:o,handlersByElement:a}=this,h={...ps,...i};let c=a.get(h.srcElement);c||(c=[],a.set(h.srcElement,c));const l={type:t,handler:e,srcElement:h.srcElement,priority:h.priority};s&&(l.once=!0),n&&(l.passive=!0),o.push(l),this._active=this._active||!l.passive;let u=c.length-1;for(;u>=0&&!(c[u].priority>=l.priority);)u--;c.splice(u+1,0,l)}remove(t,e){const{handlers:i,handlersByElement:s}=this;for(let n=i.length-1;n>=0;n--){const o=i[n];if(o.type===t&&o.handler===e){i.splice(n,1);const a=s.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&s.delete(o.srcElement)}}this._active=i.some(n=>!n.passive)}_emit(t,e){const i=this.handlersByElement.get(e);if(i){let s=!1;const n=()=>{t.handled=!0},o=()=>{t.handled=!0,s=!0},a=[];for(let h=0;h<i.length;h++){const{type:c,handler:l,once:u}=i[h];if(l({...t,type:c,stopPropagation:n,stopImmediatePropagation:o}),u&&a.push(i[h]),s)break}for(let h=0;h<a.length;h++){const{type:c,handler:l}=a[h];this.remove(c,l)}}}_normalizeEvent(t){const e=this.eventManager.getElement();return{...t,...ds(t),...us(t,e),preventDefault:()=>{t.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:e}}}function gs(r){if("recognizer"in r)return r;let t;const e=Array.isArray(r)?[...r]:[r];if(typeof e[0]=="function"){const i=e.shift(),s=e.shift()||{};t=new i(s)}else t=e.shift();return{recognizer:t,recognizeWith:typeof e[0]=="string"?[e[0]]:e[0],requireFailure:typeof e[1]=="string"?[e[1]]:e[1]}}class ms{constructor(t=null,e={}){if(this._onBasicInput=i=>{this.manager.emit(i.srcEvent.type,i)},this._onOtherEvent=i=>{this.manager.emit(i.type,i)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...e},this.events=new Map,this.element=t,!!t){this.manager=new ts(t,this.options);for(const i of this.options.recognizers){const{recognizer:s,recognizeWith:n,requireFailure:o}=gs(i);this.manager.add(s),n&&s.recognizeWith(n),o&&s.requireFailure(o)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new Ie(t,this._onOtherEvent,{enable:!1}),this.moveInput=new es(t,this._onOtherEvent,{enable:!1}),this.keyInput=new is(t,this._onOtherEvent,{enable:!1,tabIndex:e.tabIndex}),this.contextmenuInput=new ss(t,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(t,e,i){this._addEventHandler(t,e,i,!1)}once(t,e,i){this._addEventHandler(t,e,i,!0)}watch(t,e,i){this._addEventHandler(t,e,i,!1,!0)}off(t,e){this._removeEventHandler(t,e)}_toggleRecognizer(t,e){const{manager:i}=this;if(!i)return;const s=i.get(t);s&&(s.set({enable:e}),i.touchAction.update()),this.wheelInput?.enableEventType(t,e),this.moveInput?.enableEventType(t,e),this.keyInput?.enableEventType(t,e),this.contextmenuInput?.enableEventType(t,e)}_addEventHandler(t,e,i,s,n){if(typeof t!="string"){i=e;for(const[c,l]of Object.entries(t))this._addEventHandler(c,l,i,s,n);return}const{manager:o,events:a}=this;if(!o)return;let h=a.get(t);if(!h){const c=this._getRecognizerName(t)||t;h=new fs(this,c),a.set(t,h),o&&o.on(t,h.handleEvent)}h.add(t,e,i,s,n),h.isEmpty()||this._toggleRecognizer(h.recognizerName,!0)}_removeEventHandler(t,e){if(typeof t!="string"){for(const[n,o]of Object.entries(t))this._removeEventHandler(n,o);return}const{events:i}=this,s=i.get(t);if(s&&(s.remove(t,e),s.isEmpty())){const{recognizerName:n}=s;let o=!1;for(const a of i.values())if(a.recognizerName===n&&!a.isEmpty()){o=!0;break}o||this._toggleRecognizer(n,!1)}}_getRecognizerName(t){return this.manager.recognizers.find(e=>e.getEventNames().includes(t))?.options.event}}const qt=512;function ws(r){const{width:t,height:e,pitch:i=0}=r;let{longitude:s,latitude:n,zoom:o,bearing:a=0}=r;(s<-180||s>180)&&(s=Dt(s+180,360)-180),(a<-180||a>180)&&(a=Dt(a+180,360)-180);const h=Ae(e/qt);if(o<=h)o=h,n=0;else{const c=e/2/Math.pow(2,o),l=Ot([0,c])[1];if(n<l)n=l;else{const u=Ot([0,qt-c])[1];n>u&&(n=u)}}return{width:t,height:e,longitude:s,latitude:n,zoom:o,pitch:i,bearing:a}}const fe=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,_s=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,vs=`
${fe}
${_s}
`,ys=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,Es=`
${fe}
${ys}
`,bs=ne(Cs),Ps=ne(Rs),Ss=[0,0,0,1],Ms=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function Ts(r,t){const[e,i,s]=r,n=Oe([e,i,s],t);return Number.isFinite(s)?n:[n[0],n[1],0]}function Cs({viewport:r,center:t}){return new ot(r.viewProjectionMatrix).invert().transform(t)}function Rs({viewport:r,shadowMatrices:t}){const e=[],i=r.pixelUnprojectionMatrix,s=r.isGeospatial?void 0:1,n=[[0,0,s],[r.width,0,s],[0,r.height,s],[r.width,r.height,s],[0,0,-1],[r.width,0,-1],[0,r.height,-1],[r.width,r.height,-1]].map(o=>Ts(o,i));for(const o of t){const a=o.clone().translate(new rt(r.center).negate()),h=n.map(l=>a.transform(l)),c=new ot().ortho({left:Math.min(...h.map(l=>l[0])),right:Math.max(...h.map(l=>l[0])),bottom:Math.min(...h.map(l=>l[1])),top:Math.max(...h.map(l=>l[1])),near:Math.min(...h.map(l=>-l[2])),far:Math.max(...h.map(l=>-l[2]))});e.push(c.multiplyRight(o))}return e}function xs(r){const{shadowEnabled:t=!0,project:e}=r;if(!t||!e||!r.shadowMatrices||!r.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};const i=se.getUniforms(e),s=bs({viewport:e.viewport,center:i.center}),n=[],o=Ps({shadowMatrices:r.shadowMatrices,viewport:e.viewport}).slice();for(let h=0;h<r.shadowMatrices.length;h++){const c=o[h],l=c.clone().translate(new rt(e.viewport.center).negate());i.coordinateSystem===De.LNGLAT&&i.projectionMode===re.WEB_MERCATOR?(o[h]=l,n[h]=s):(o[h]=c.clone().multiplyRight(Ms),n[h]=l.transform(s))}const a={drawShadowMap:!!r.drawToShadowMap,useShadowMap:r.shadowMaps?r.shadowMaps.length>0:!1,color:r.shadowColor||Ss,lightId:r.shadowLightId||0,lightCount:r.shadowMatrices.length,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};for(let h=0;h<o.length;h++)a[`viewProjectionMatrix${h}`]=o[h],a[`projectCenter${h}`]=n[h];for(let h=0;h<2;h++)a[`shadow_uShadowMap${h}`]=r.shadowMaps&&r.shadowMaps[h]||r.dummyShadowMap;return a}const $t={name:"shadow",dependencies:[se],vs,fs:Es,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:xs,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},Ls=[ze],ks=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],Is=[];function As(r){const t=Ve.getDefaultShaderAssembler();for(const i of Ls)t.addDefaultModule(i);const e=r==="glsl"?ks:Is;for(const i of e)t.addShaderHook(i);return t}const Ds=[255,255,255],Os=1;let Vs=0;class zs{constructor(t={}){this.type="ambient";const{color:e=Ds}=t,{intensity:i=Os}=t;this.id=t.id||`ambient-${Vs++}`,this.color=e,this.intensity=i}}const Fs=[255,255,255],Ns=1,Us=[0,0,-1];let js=0;class Xt{constructor(t={}){this.type="directional";const{color:e=Fs}=t,{intensity:i=Ns}=t,{direction:s=Us}=t,{_shadow:n=!1}=t;this.id=t.id||`directional-${js++}`,this.color=e,this.intensity=i,this.type="directional",this.direction=new rt(s).normalize().toArray(),this.shadow=n}getProjectedLight(t){return this}}class Bs extends oe{constructor(t,e){super(t,e);const i=t.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),s=t.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=t.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[i],depthStencilAttachment:s})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(t){const e=this.fbo,i=this.device.canvasContext.cssToDeviceRatio(),s=t.viewports[0],n=s.width*i,o=s.height*i,a=[1,1,1,1];(n!==e.width||o!==e.height)&&e.resize({width:n,height:o}),super.render({...t,clearColor:a,target:e,pass:"shadow"})}getLayerParameters(t,e,i){return{...t.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(t){return t.props.shadowEnabled!==!1}getShaderModuleProps(t,e,i){return{shadow:{project:i.project,drawToShadowMap:!0}}}}const Gs={color:[255,255,255],intensity:1},Yt=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],Ws=[0,0,0,200/255];class ge{constructor(t={}){this.id="lighting-effect",this.shadowColor=Ws,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(t)}setup(t){this.context=t;const{device:e,deck:i}=t;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(e),i._addDefaultShaderModule($t),this.dummyShadowMap=e.createTexture({width:1,height:1}))}setProps(t){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const e in t){const i=t[e];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(e=>e.shadow),this.context&&this.setup(this.context),this.props=t}preRender({layers:t,layerFilter:e,viewports:i,onViewportActive:s,views:n}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:t,layerFilter:e,viewports:i,onViewportActive:s,views:n,shaderModuleProps:{shadow:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(t,e){const i=this.shadow?{project:e.project,shadowMaps:this.shadowPasses.map(o=>o.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},s={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(o=>o.getProjectedLight({layer:t})),pointLights:this.pointLights.map(o=>o.getProjectedLight({layer:t}))},n=t.props.material;return{shadow:i,lighting:s,phongMaterial:n,gouraudMaterial:n}}cleanup(t){for(const e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,t.deck._removeDefaultShaderModule($t))}_calculateMatrices(){const t=[];for(const e of this.directionalLights){const i=new ot().lookAt({eye:new rt(e.direction).negate()});t.push(i)}return t}_createShadowPasses(t){for(let e=0;e<this.directionalLights.length;e++){const i=new Bs(t);this.shadowPasses[e]=i}}_applyDefaultLights(){const{ambientLight:t,pointLights:e,directionalLights:i}=this;!t&&e.length===0&&i.length===0&&(this.ambientLight=new zs(Gs),this.directionalLights.push(new Xt(Yt[0]),new Xt(Yt[1])))}}let Hs=1,Zs=1;class me{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(t){const{delay:e=0,duration:i=Number.POSITIVE_INFINITY,rate:s=1,repeat:n=1}=t,o=Hs++,a={time:0,delay:e,duration:i,rate:s,repeat:n};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(t){this.channels.delete(t);for(const[e,i]of this.animations)i.channel===t&&this.detachAnimation(e)}isFinished(t){const e=this.channels.get(t);return e===void 0?!1:this.time>=e.delay+e.duration*e.repeat}getTime(t){if(t===void 0)return this.time;const e=this.channels.get(t);return e===void 0?-1:e.time}setTime(t){this.time=Math.max(0,t);const e=this.channels.values();for(const s of e)this._setChannelTime(s,this.time);const i=this.animations.values();for(const s of i){const{animation:n,channel:o}=s;n.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(t,e){const i=Zs++;return this.animations.set(i,{animation:t,channel:e}),t.setTime(this.getTime(e)),i}detachAnimation(t){this.animations.delete(t)}update(t){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=t),this.setTime(this.time+(t-this.lastEngineTime)),this.lastEngineTime=t)}_setChannelTime(t,e){const i=e-t.delay,s=t.duration*t.repeat;i>=s?t.time=t.duration*t.rate:(t.time=Math.max(0,i)%t.duration,t.time*=t.rate)}}function qs(r){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(r):setTimeout(r,1e3/60)}function $s(r){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(r):clearTimeout(r)}let Xs=0;const Ys={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:r=>console.error(r),stats:_t.stats.get(`animation-loop-${Xs++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class Ks{device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(t){if(this.props={...Ys,...t},t=this.props,!t.device)throw new Error("No device provided");const{useDevicePixels:e=!0}=this.props;this.stats=t.stats||new Pt({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:t.autoResizeViewport,autoResizeDrawingBuffer:t.autoResizeDrawingBuffer,useDevicePixels:e}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(t){if(this.props.onError(t),this._error=Error(),this.device?.canvasContext?.canvas instanceof HTMLCanvasElement){const i=document.createElement("h1");i.innerHTML=t.message,i.style.position="absolute",i.style.top="20%",i.style.left="10px",i.style.color="black",i.style.backgroundColor="red",document.body.appendChild(i)}}setNeedsRedraw(t){return this.needsRedraw=this.needsRedraw||t,this}setProps(t){return"autoResizeViewport"in t&&(this.props.autoResizeViewport=t.autoResizeViewport||!1),"autoResizeDrawingBuffer"in t&&(this.props.autoResizeDrawingBuffer=t.autoResizeDrawingBuffer||!1),"useDevicePixels"in t&&(this.props.useDevicePixels=t.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let t;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(t!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(t){const e=t instanceof Error?t:new Error("Unknown error");throw this.props.onError(e),e}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(t){return this.timeline=t,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(t=>{this._resolveNextFrame=t})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(t){this.display&&(this.display.destroy(),this.display.animationLoop=null),t&&(t.animationLoop=this),this.display=t}_requestAnimationFrame(){this._running&&(this._animationFrameId=qs(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&($s(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(t){if(this.display){this.display._renderFrame(t);return}this.props.onRender(this._getAnimationProps()),this.device?.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){const t=this.device?.canvasContext?.canvas;if(!this.device||!t)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:t,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:t,height:e,aspect:i}=this._getSizeAndAspect();(t!==this.animationProps.width||e!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=t,this.animationProps.height=e,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=this.device.canvasContext?.canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const t=document.createElement("div");document.body.appendChild(t),t.style.position="relative";const e=document.createElement("div");e.style.position="absolute",e.style.left="10px",e.style.bottom="10px",e.style.width="300px",e.style.background="white",this.canvas instanceof HTMLCanvasElement&&t.appendChild(this.canvas),t.appendChild(e);const i=this.props.onAddHTML(e);i&&(e.innerHTML=i)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};const[t,e]=this.device?.canvasContext?.getPixelSize()||[1,1];let i=1;const s=this.device?.canvasContext?.canvas;return s&&s.clientHeight?i=s.clientWidth/s.clientHeight:t>0&&e>0&&(i=t/e),{width:t,height:e,aspect:i}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.props.autoResizeDrawingBuffer&&this.device?.canvasContext?.resize({useDevicePixels:this.props.useDevicePixels})}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(t){t instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[t.offsetX,t.offsetY])}_onMouseleave(t){this._getAnimationProps()._mousePosition=null}}class Js{constructor(t,e,i){this._loadCount=0,this._subscribers=new Set,this.id=t,this.context=i,this.setData(e)}subscribe(t){this._subscribers.add(t)}unsubscribe(t){this._subscribers.delete(t)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(t,e){if(t===this._data&&!e)return;this._data=t;const i=++this._loadCount;let s=t;typeof t=="string"&&(s=ti(t)),s instanceof Promise?(this.isLoaded=!1,this._loader=s.then(n=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=n)}).catch(n=>{this._loadCount===i&&(this.isLoaded=!0,this._error=n||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=t);for(const n of this._subscribers)n.onChange(this.getData())}}class Qs{constructor(t){this.protocol=t.protocol||"resource://",this._context={device:t.device,gl:t.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(t){return t.startsWith(this.protocol)?!0:t in this._resources}add({resourceId:t,data:e,forceUpdate:i=!1,persistent:s=!0}){let n=this._resources[t];n?n.setData(e,i):(n=new Js(t,e,this._context),this._resources[t]=n),n.persistent=s}remove(t){const e=this._resources[t];e&&(e.delete(),delete this._resources[t])}unsubscribe({consumerId:t}){const e=this._consumers[t];if(e){for(const i in e){const s=e[i],n=this._resources[s.resourceId];n&&n.unsubscribe(s)}delete this._consumers[t],this.prune()}}subscribe({resourceId:t,onChange:e,consumerId:i,requestId:s="default"}){const{_resources:n,protocol:o}=this;t.startsWith(o)&&(t=t.replace(o,""),n[t]||this.add({resourceId:t,data:null,persistent:!1}));const a=n[t];if(this._track(i,s,a,e),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const t in this._resources)this._resources[t].delete()}_track(t,e,i,s){const n=this._consumers,o=n[t]=n[t]||{};let a=o[e];const h=a&&a.resourceId&&this._resources[a.resourceId];h&&(h.unsubscribe(a),this.prune()),i&&(a?(a.onChange=s,a.resourceId=i.id):a={onChange:s,resourceId:i.id},o[e]=a,i.subscribe(a))}_prune(){this._pruneRequest=null;for(const t of Object.keys(this._resources)){const e=this._resources[t];!e.persistent&&!e.inUse()&&(e.delete(),delete this._resources[t])}}}const tn="layerManager.setLayers",en="layerManager.activateViewport";class sn{constructor(t,e){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=a=>{ft(en,this,a),a&&(this.context.viewport=a)};const{deck:i,stats:s,viewport:n,timeline:o}=e||{};this.layers=[],this.resourceManager=new Qs({device:t,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:t,gl:t?.gl,deck:i,shaderAssembler:As(t?.info?.shadingLanguage||"glsl"),defaultShaderModules:[$i],renderPass:void 0,stats:s||new Pt({id:"deck.gl"}),viewport:n||new ae({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new me,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const t of this.layers)this._finalizeLayer(t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);for(const i of this.layers){const s=i.getNeedsRedraw(t);e=e||s}return e}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(t){this._needsRedraw=this._needsRedraw||t}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t}getLayers({layerIds:t}={}){return t?this.layers.filter(e=>t.find(i=>e.id.indexOf(i)===0)):this.layers}setProps(t){"debug"in t&&(this._debug=t.debug),"userData"in t&&(this.context.userData=t.userData),"layers"in t&&(this._nextLayers=t.layers),"onError"in t&&(this.context.onError=t.onError)}setLayers(t,e){ft(tn,this,e,t),this._lastRenderedLayers=t;const i=W(t,Boolean);for(const s of i)s.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){const t=this.needsUpdate();t&&(this.setNeedsRedraw(`updating layers: ${t}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,t)),this._nextLayers=null}addDefaultShaderModule(t){const{defaultShaderModules:e}=this.context;e.find(i=>i.name===t.name)||(e.push(t),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(t){const{defaultShaderModules:e}=this.context,i=e.findIndex(s=>s.name===t.name);i>=0&&(e.splice(i,1),this._defaultShaderModulesChanged=!0)}_handleError(t,e,i){i.raiseError(e,`${t} of ${i}`)}_updateLayers(t,e){const i={};for(const o of t)i[o.id]?y.warn(`Multiple old layers with same id ${o.id}`)():i[o.id]=o;if(this._defaultShaderModulesChanged){for(const o of t)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const s=[];this._updateSublayersRecursively(e,i,s),this._finalizeOldLayers(i);let n=!1;for(const o of s)if(o.hasUniformTransition()){n=`Uniform transition in ${o}`;break}this._needsUpdate=n,this.layers=s}_updateSublayersRecursively(t,e,i){for(const s of t){s.context=this.context;const n=e[s.id];n===null&&y.warn(`Multiple new layers with same id ${s.id}`)(),e[s.id]=null;let o=null;try{this._debug&&n!==s&&s.validateProps(),n?(this._transferLayerState(n,s),this._updateLayer(s)):this._initializeLayer(s),i.push(s),o=s.isComposite?s.getSubLayers():null}catch(a){this._handleError("matching",a,s)}o&&this._updateSublayersRecursively(o,e,i)}}_finalizeOldLayers(t){for(const e in t){const i=t[e];i&&this._finalizeLayer(i)}}_initializeLayer(t){try{t._initialize(),t.lifecycle=B.INITIALIZED}catch(e){this._handleError("initialization",e,t)}}_transferLayerState(t,e){e._transferState(t),e.lifecycle=B.MATCHED,e!==t&&(t.lifecycle=B.AWAITING_GC)}_updateLayer(t){try{t._update()}catch(e){this._handleError("update",e,t)}}_finalizeLayer(t){this._needsRedraw=this._needsRedraw||`finalized ${t}`,t.lifecycle=B.AWAITING_FINALIZATION;try{t._finalize(),t.lifecycle=B.FINALIZED}catch(e){this._handleError("finalization",e,t)}}}class nn{constructor(t){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=t.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=t.eventManager,this._eventCallbacks={onViewStateChange:t.onViewStateChange,onInteractionStateChange:t.onInteractionStateChange},Object.seal(this),this.setProps(t)}finalize(){for(const t in this.controllers){const e=this.controllers[t];e&&e.finalize()}this.controllers={}}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t,this._needsRedraw=this._needsRedraw||t}updateViewStates(){for(const t in this.controllers){const e=this.controllers[t];e&&e.updateTransition()}}getViewports(t){return t?this._viewports.filter(e=>e.containsPixel(t)):this._viewports}getViews(){const t={};return this.views.forEach(e=>{t[e.id]=e}),t}getView(t){return this.views.find(e=>e.id===t)}getViewState(t){const e=typeof t=="string"?this.getView(t):t,i=e&&this.viewState[e.getViewStateId()]||this.viewState;return e?e.filterViewState(i):i}getViewport(t){return this._viewportMap[t]}unproject(t,e){const i=this.getViewports(),s={x:t[0],y:t[1]};for(let n=i.length-1;n>=0;--n){const o=i[n];if(o.containsPixel(s)){const a=t.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,e)}}return null}setProps(t){t.views&&this._setViews(t.views),t.viewState&&this._setViewState(t.viewState),("width"in t||"height"in t)&&this._setSize(t.width,t.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(t,e){(t!==this.width||e!==this.height)&&(this.width=t,this.height=e,this.setNeedsUpdate("Size changed"))}_setViews(t){t=W(t,Boolean),this._diffViews(t,this.views)&&this.setNeedsUpdate("views changed"),this.views=t}_setViewState(t){t?(!q(t,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=t):y.warn("missing `viewState` or `initialViewState`")()}_createController(t,e){const i=e.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:n=>this.getView(t.id)?.makeViewport({viewState:n,width:this.width,height:this.height})})}_updateController(t,e,i,s){const n=t.controller;if(n&&i){const o={...e,...n,id:t.id,x:i.x,y:i.y,width:i.width,height:i.height};return(!s||s.constructor!==n.type)&&(s=this._createController(t,o)),s&&s.setProps(o),s}return null}_rebuildViewports(){const{views:t}=this,e=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let s=t.length;s--;){const n=t[s],o=this.getViewState(n),a=n.makeViewport({viewState:o,width:this.width,height:this.height});let h=e[n.id];const c=!!n.controller;c&&!h&&(i=!0),(i||!c)&&h&&(h.finalize(),h=null),this.controllers[n.id]=this._updateController(n,o,a,h),a&&this._viewports.unshift(a)}for(const s in e){const n=e[s];n&&!this.controllers[s]&&n.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(t=>{t.id&&(this._viewportMap[t.id]=this._viewportMap[t.id]||t)})}_diffViews(t,e){return t.length!==e.length?!0:t.some((i,s)=>!t[s].equals(e[s]))}}const rn=/([0-9]+\.?[0-9]*)(%|px)/;function L(r){switch(typeof r){case"number":return{position:r,relative:!1};case"string":const t=rn.exec(r);if(t&&t.length>=3){const e=t[2]==="%",i=parseFloat(t[1]);return{position:e?i/100:i,relative:e}}default:throw new Error(`Could not parse position string ${r}`)}}function k(r,t){return r.relative?Math.round(r.position*t):r.position}class we{constructor(t){const{id:e,x:i=0,y:s=0,width:n="100%",height:o="100%",padding:a=null}=t;this.id=e||this.constructor.displayName||"view",this.props={...t,id:this.id},this._x=L(i),this._y=L(s),this._width=L(n),this._height=L(o),this._padding=a&&{left:L(a.left||0),right:L(a.right||0),top:L(a.top||0),bottom:L(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(t){return this===t?!0:this.constructor===t.constructor&&q(this.props,t.props,2)}makeViewport({width:t,height:e,viewState:i}){i=this.filterViewState(i);const s=this.getDimensions({width:t,height:e});if(!s.height||!s.width)return null;const n=this.getViewportType(i);return new n({...i,...this.props,...s})}getViewStateId(){const{viewState:t}=this.props;return typeof t=="string"?t:t?.id||this.id}filterViewState(t){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const e={...t};for(const i in this.props.viewState)i!=="id"&&(e[i]=this.props.viewState[i]);return e}return t}getDimensions({width:t,height:e}){const i={x:k(this._x,t),y:k(this._y,e),width:k(this._width,t),height:k(this._height,e)};return this._padding&&(i.padding={left:k(this._padding.left,t),top:k(this._padding.top,e),right:k(this._padding.right,t),bottom:k(this._padding.bottom,e)}),i}get controller(){const t=this.props.controller;return t?t===!0?{type:this.ControllerType}:typeof t=="function"?{type:t}:{type:this.ControllerType,...t}:null}}const Kt=()=>{},yt={BREAK:1,SNAP_TO_END:2,IGNORE:3},on=r=>r,an=yt.BREAK;class hn{constructor(t){this._onTransitionUpdate=e=>{const{time:i,settings:{interpolator:s,startProps:n,endProps:o,duration:a,easing:h}}=e,c=h(i/a),l=s.interpolateProps(n,o,c);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=t.getControllerState,this.propsInTransition=null,this.transition=new ei(t.timeline),this.onViewStateChange=t.onViewStateChange||Kt,this.onStateChange=t.onStateChange||Kt}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(t){let e=!1;const i=this.props;if(this.props=t,!i||this._shouldIgnoreViewportChange(i,t))return!1;if(this._isTransitionEnabled(t)){let s=i;if(this.transition.inProgress){const{interruption:n,endProps:o}=this.transition.settings;s={...i,...n===yt.SNAP_TO_END?o:this.propsInTransition||i}}this._triggerTransition(s,t),e=!0}else this.transition.cancel();return e}updateTransition(){this.transition.update()}_isTransitionEnabled(t){const{transitionDuration:e,transitionInterpolator:i}=t;return(e>0||e==="auto")&&!!i}_isUpdateDueToCurrentTransition(t){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(t,this.propsInTransition):!1}_shouldIgnoreViewportChange(t,e){return this.transition.inProgress?this.transition.settings.interruption===yt.IGNORE||this._isUpdateDueToCurrentTransition(e):this._isTransitionEnabled(e)?e.transitionInterpolator.arePropsEqual(t,e):!0}_triggerTransition(t,e){const i=this.getControllerState(t),s=this.getControllerState(e).shortestPathFrom(i),n=e.transitionInterpolator,o=n.getDuration?n.getDuration(t,e):e.transitionDuration;if(o===0)return;const a=n.initializeProps(t,s);this.propsInTransition={};const h={duration:o,easing:e.transitionEasing||on,interpolator:n,interruption:e.transitionInterruption||an,startProps:a.start,endProps:a.end,onStart:e.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(e.onTransitionInterrupt),onEnd:this._onTransitionEnd(e.onTransitionEnd)};this.transition.start(h),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(t){return e=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),t?.(e)}}}class cn{constructor(t){const{compare:e,extract:i,required:s}=t;this._propsToCompare=e,this._propsToExtract=i||e,this._requiredProps=s}arePropsEqual(t,e){for(const i of this._propsToCompare)if(!(i in t)||!(i in e)||!Fe(t[i],e[i]))return!1;return!0}initializeProps(t,e){const i={},s={};for(const n of this._propsToExtract)(n in t||n in e)&&(i[n]=t[n],s[n]=e[n]);return this._checkRequiredProps(i),this._checkRequiredProps(s),{start:i,end:s}}getDuration(t,e){return e.transitionDuration}_checkRequiredProps(t){this._requiredProps&&this._requiredProps.forEach(e=>{const i=t[e];S(Number.isFinite(i)||Array.isArray(i),`${e} is required for transition`)})}}const ln=["longitude","latitude","zoom","bearing","pitch"],dn=["longitude","latitude","zoom"];class Mt extends cn{constructor(t={}){const e=Array.isArray(t)?t:t.transitionProps,i=Array.isArray(t)?{}:t;i.transitionProps=Array.isArray(e)?{compare:e,required:e}:e||{compare:ln,required:dn},super(i.transitionProps),this.opts=i}initializeProps(t,e){const i=super.initializeProps(t,e),{makeViewport:s,around:n}=this.opts;if(s&&n){const o=s(t),a=s(e),h=o.unproject(n);i.start.around=n,Object.assign(i.end,{around:a.project(h),aroundPosition:h,width:e.width,height:e.height})}return i}interpolateProps(t,e,i){const s={};for(const n of this._propsToExtract)s[n]=Vt(t[n]||0,e[n]||0,i);if(e.aroundPosition&&this.opts.makeViewport){const n=this.opts.makeViewport({...e,...s});Object.assign(s,n.panByPosition(e.aroundPosition,Vt(t.around,e.around,i)))}return s}}const I={transitionDuration:0},un=300,K=r=>1-(1-r)*(1-r),F={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},O={};class _e{constructor(t){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new hn({...t,getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=t.eventManager,this.onViewStateChange=t.onViewStateChange||(()=>{}),this.onStateChange=t.onStateChange||(()=>{}),this.makeViewport=t.makeViewport}set events(t){this.toggleEvents(this._customEvents,!1),this.toggleEvents(t,!0),this._customEvents=t,this.props&&this.setProps(this.props)}finalize(){for(const t in this._events)this._events[t]&&this.eventManager?.off(t,this.handleEvent);this.transitionManager.finalize()}handleEvent(t){this._controllerState=void 0;const e=this._eventStartBlocked;switch(t.type){case"panstart":return e?!1:this._onPanStart(t);case"panmove":return this._onPan(t);case"panend":return this._onPanEnd(t);case"pinchstart":return e?!1:this._onPinchStart(t);case"pinchmove":return this._onPinch(t);case"pinchend":return this._onPinchEnd(t);case"multipanstart":return e?!1:this._onMultiPanStart(t);case"multipanmove":return this._onMultiPan(t);case"multipanend":return this._onMultiPanEnd(t);case"dblclick":return this._onDoubleClick(t);case"wheel":return this._onWheel(t);case"keydown":return this._onKeyDown(t);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(t){const{x:e,y:i}=this.props,{offsetCenter:s}=t;return[s.x-e,s.y-i]}isPointInBounds(t,e){const{width:i,height:s}=this.props;if(e&&e.handled)return!1;const n=t[0]>=0&&t[0]<=i&&t[1]>=0&&t[1]<=s;return n&&e&&e.stopPropagation(),n}isFunctionKeyPressed(t){const{srcEvent:e}=t;return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(t){const e=setTimeout(()=>{this._eventStartBlocked===e&&(this._eventStartBlocked=null)},t);this._eventStartBlocked=e}setProps(t){t.dragMode&&(this.dragMode=t.dragMode),this.props=t,"transitionInterpolator"in t||(t.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(t);const{inertia:e}=t;this.inertia=Number.isFinite(e)?e:e===!0?un:0;const{scrollZoom:i=!0,dragPan:s=!0,dragRotate:n=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:h=!1,keyboard:c=!0}=t,l=!!this.onViewStateChange;this.toggleEvents(F.WHEEL,l&&i),this.toggleEvents(F.PAN,l),this.toggleEvents(F.PINCH,l&&(a||h)),this.toggleEvents(F.MULTI_PAN,l&&h),this.toggleEvents(F.DOUBLE_CLICK,l&&o),this.toggleEvents(F.KEYBOARD,l&&c),this.scrollZoom=i,this.dragPan=s,this.dragRotate=n,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=h,this.keyboard=c}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(t,e){this.eventManager&&t.forEach(i=>{this._events[i]!==e&&(this._events[i]=e,e?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(t,e=null,i={}){const s={...t.getViewportProps(),...e},n=this.controllerState!==t;if(this.state=t.getState(),this._setInteractionState(i),n){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:s,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(t){this.onViewStateChange({...t,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(t){Object.assign(this._interactionState,t),this.onStateChange(this._interactionState)}_onPanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let i=this.isFunctionKeyPressed(t)||t.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);const s=this.controllerState[i?"panStart":"rotateStart"]({pos:e});return this._panMove=i,this.updateViewport(s,I,{isDragging:!0}),!0}_onPan(t){return this.isDragging()?this._panMove?this._onPanMove(t):this._onPanRotate(t):!1}_onPanEnd(t){return this.isDragging()?this._panMove?this._onPanMoveEnd(t):this._onPanRotateEnd(t):!1}_onPanMove(t){if(!this.dragPan)return!1;const e=this.getCenter(t),i=this.controllerState.pan({pos:e});return this.updateViewport(i,I,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(t){const{inertia:e}=this;if(this.dragPan&&e&&t.velocity){const i=this.getCenter(t),s=[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2],n=this.controllerState.pan({pos:s}).panEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:K},{isDragging:!1,isPanning:!0})}else{const i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(t){if(!this.dragRotate)return!1;const e=this.getCenter(t),i=this.controllerState.rotate({pos:e});return this.updateViewport(i,I,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(t){const{inertia:e}=this;if(this.dragRotate&&e&&t.velocity){const i=this.getCenter(t),s=[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2],n=this.controllerState.rotate({pos:s}).rotateEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:K},{isDragging:!1,isRotating:!0})}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(t){if(!this.scrollZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;t.srcEvent.preventDefault();const{speed:i=.01,smooth:s=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:n}=t;let o=2/(1+Math.exp(-Math.abs(n*i)));n<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:e,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:e}),transitionDuration:s?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.controllerState.rotateStart({pos:e});return this.updateViewport(i,I,{isDragging:!0}),!0}_onMultiPan(t){if(!this.touchRotate||!this.isDragging())return!1;const e=this.getCenter(t);e[0]-=t.deltaX;const i=this.controllerState.rotate({pos:e});return this.updateViewport(i,I,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this;if(this.touchRotate&&e&&t.velocityY){const i=this.getCenter(t),s=[i[0],i[1]+=t.velocityY*e/2],n=this.controllerState.rotate({pos:s});this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:K},{isDragging:!1,isRotating:!0}),this.blockEvents(e)}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.controllerState.zoomStart({pos:e}).rotateStart({pos:e});return O._startPinchRotation=t.rotation,O._lastPinchEvent=t,this.updateViewport(i,I,{isDragging:!0}),!0}_onPinch(t){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let e=this.controllerState;if(this.touchZoom){const{scale:i}=t,s=this.getCenter(t);e=e.zoom({pos:s,scale:i})}if(this.touchRotate){const{rotation:i}=t;e=e.rotate({deltaAngleX:O._startPinchRotation-i})}return this.updateViewport(e,I,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),O._lastPinchEvent=t,!0}_onPinchEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this,{_lastPinchEvent:i}=O;if(this.touchZoom&&e&&i&&t.scale!==i.scale){const s=this.getCenter(t);let n=this.controllerState.rotateEnd();const o=Math.log2(t.scale),a=(o-Math.log2(i.scale))/(t.deltaTime-i.deltaTime),h=Math.pow(2,o+a*e/2);n=n.zoom({pos:s,scale:h}).zoomEnd(),this.updateViewport(n,{...this._getTransitionProps({around:s}),transitionDuration:e,transitionEasing:K},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(e)}else{const s=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(s,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return O._startPinchRotation=null,O._lastPinchEvent=null,!0}_onDoubleClick(t){if(!this.doubleClickZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.isFunctionKeyPressed(t),s=this.controllerState.zoom({pos:e,scale:i?.5:2});return this.updateViewport(s,this._getTransitionProps({around:e}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(t){if(!this.keyboard)return!1;const e=this.isFunctionKeyPressed(t),{zoomSpeed:i,moveSpeed:s,rotateSpeedX:n,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let h;const c={};switch(t.srcEvent.code){case"Minus":h=e?a.zoomOut(i).zoomOut(i):a.zoomOut(i),c.isZooming=!0;break;case"Equal":h=e?a.zoomIn(i).zoomIn(i):a.zoomIn(i),c.isZooming=!0;break;case"ArrowLeft":e?(h=a.rotateLeft(n),c.isRotating=!0):(h=a.moveLeft(s),c.isPanning=!0);break;case"ArrowRight":e?(h=a.rotateRight(n),c.isRotating=!0):(h=a.moveRight(s),c.isPanning=!0);break;case"ArrowUp":e?(h=a.rotateUp(o),c.isRotating=!0):(h=a.moveUp(s),c.isPanning=!0);break;case"ArrowDown":e?(h=a.rotateDown(o),c.isRotating=!0):(h=a.moveDown(s),c.isPanning=!0);break;default:return!1}return this.updateViewport(h,this._getTransitionProps(),c),!0}_getTransitionProps(t){const{transition:e}=this;return!e||!e.transitionInterpolator?I:t?{...e,transitionInterpolator:new Mt({...t,...e.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:e}}class pn{constructor(t,e){this._viewportProps=this.applyConstraints(t),this._state=e}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Jt=5,fn=1.2;class ve extends pn{constructor(t){const{width:e,height:i,latitude:s,longitude:n,zoom:o,bearing:a=0,pitch:h=0,altitude:c=1.5,position:l=[0,0,0],maxZoom:u=20,minZoom:d=0,maxPitch:p=60,minPitch:f=0,startPanLngLat:g,startZoomLngLat:m,startRotatePos:w,startBearing:_,startPitch:b,startZoom:T,normalize:C=!0}=t;S(Number.isFinite(n)),S(Number.isFinite(s)),S(Number.isFinite(o)),super({width:e,height:i,latitude:s,longitude:n,zoom:o,bearing:a,pitch:h,altitude:c,maxZoom:u,minZoom:d,maxPitch:p,minPitch:f,normalize:C,position:l},{startPanLngLat:g,startZoomLngLat:m,startRotatePos:w,startBearing:_,startPitch:b,startZoom:T}),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanLngLat:this._unproject(t)})}pan({pos:t,startPos:e}){const i=this.getState().startPanLngLat||this._unproject(e);if(!i)return this;const n=this.makeViewport(this.getViewportProps()).panByPosition(i,t);return this._getUpdatedState(n)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:i=0}){const{startRotatePos:s,startBearing:n,startPitch:o}=this.getState();if(!s||n===void 0||o===void 0)return this;let a;return t?a=this._getNewRotation(t,s,o,n):a={bearing:n+e,pitch:o+i},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:t}){return this._getUpdatedState({startZoomLngLat:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:i}){let{startZoom:s,startZoomLngLat:n}=this.getState();if(n||(s=this.getViewportProps().zoom,n=this._unproject(e)||this._unproject(t)),!n)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let h=s+Math.log2(i);h=N(h,a,o);const c=this.makeViewport({...this.getViewportProps(),zoom:h});return this._getUpdatedState({zoom:h,...c.panByPosition(n,t)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(t=2){return this._zoomFromCenter(t)}zoomOut(t=2){return this._zoomFromCenter(1/t)}moveLeft(t=100){return this._panFromCenter([t,0])}moveRight(t=100){return this._panFromCenter([-t,0])}moveUp(t=100){return this._panFromCenter([0,t])}moveDown(t=100){return this._panFromCenter([0,-t])}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}shortestPathFrom(t){const e=t.getViewportProps(),i={...this.getViewportProps()},{bearing:s,longitude:n}=i;return Math.abs(s-e.bearing)>180&&(i.bearing=s<0?s+360:s-360),Math.abs(n-e.longitude)>180&&(i.longitude=n<0?n+360:n-360),i}applyConstraints(t){const{maxZoom:e,minZoom:i,zoom:s}=t;t.zoom=N(s,i,e);const{maxPitch:n,minPitch:o,pitch:a}=t;t.pitch=N(a,o,n);const{normalize:h=!0}=t;return h&&Object.assign(t,ws(t)),t}_zoomFromCenter(t){const{width:e,height:i}=this.getViewportProps();return this.zoom({pos:[e/2,i/2],scale:t})}_panFromCenter(t){const{width:e,height:i}=this.getViewportProps();return this.pan({startPos:[e/2,i/2],pos:[e/2+t[0],i/2+t[1]]})}_getUpdatedState(t){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}_unproject(t){const e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_getNewRotation(t,e,i,s){const n=t[0]-e[0],o=t[1]-e[1],a=t[1],h=e[1],{width:c,height:l}=this.getViewportProps(),u=n/c;let d=0;o>0?Math.abs(l-h)>Jt&&(d=o/(h-l)*fn):o<0&&h>Jt&&(d=1-a/h),d=N(d,-1,1);const{minPitch:p,maxPitch:f}=this.getViewportProps(),g=s+180*u;let m=i;return d>0?m=i+d*(f-i):d<0&&(m=i-d*(p-i)),{pitch:m,bearing:g}}}class gn extends _e{constructor(){super(...arguments),this.ControllerState=ve,this.transition={transitionDuration:300,transitionInterpolator:new Mt({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(t){t.position=t.position||[0,0,0];const e=this.props;super.setProps(t),(!e||e.height!==t.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...t,...this.state}))}}class Tt extends we{constructor(t={}){super(t)}getViewportType(){return he}get ControllerType(){return gn}}Tt.displayName="MapView";const mn=new ge;function wn(r,t){const e=r.order??1/0,i=t.order??1/0;return e-i}class _n{constructor(t){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=t,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(t){const e=this._defaultEffects;if(!e.find(i=>i.id===t.id)){const i=e.findIndex(s=>wn(s,t)>0);i<0?e.push(t):e.splice(i,0,t),t.setup(this._context),this._setEffects(this.effects)}}setProps(t){"effects"in t&&(q(t.effects,this.effects,1)||this._setEffects(t.effects))}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}getEffects(){return this._resolvedEffects}_setEffects(t){const e={};for(const s of this.effects)e[s.id]=s;const i=[];for(const s of t){const n=e[s.id];let o=s;n&&n!==s?n.setProps?(n.setProps(s.props),o=n):n.cleanup(this._context):n||s.setup(this._context),i.push(o),delete e[s.id]}for(const s in e)e[s].cleanup(this._context);this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),t.some(s=>s instanceof ge)||this._resolvedEffects.push(mn),this._needsRedraw="effects changed"}finalize(){for(const t of this._resolvedEffects)t.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class vn extends oe{shouldDrawLayer(t){const{operation:e}=t.props;return e.includes("draw")||e.includes("terrain")}}const yn="deckRenderer.renderLayers";class En{constructor(t){this.device=t,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new vn(t),this.pickLayersPass=new le(t),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(t){this.layerFilter!==t.layerFilter&&(this.layerFilter=t.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==t.drawPickingColors&&(this.drawPickingColors=t.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(t){if(!t.viewports.length)return;const e=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...t};i.effects&&this._preRender(i.effects,i);const s=this.lastPostProcessEffect?this.renderBuffers[0]:i.target;this.lastPostProcessEffect&&(i.clearColor=[0,0,0,0],i.clearCanvas=!0);const n=e.render({...i,target:s});i.effects&&this._postRender(i.effects,i),this.renderCount++,ft(yn,this,n,t)}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}finalize(){const{renderBuffers:t}=this;for(const e of t)e.delete();t.length=0}_preRender(t,e){this.lastPostProcessEffect=null,e.preRenderStats=e.preRenderStats||{};for(const i of t)e.preRenderStats[i.id]=i.preRender(e),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:t}=this,e=this.device.canvasContext.getDrawingBufferSize();t.length===0&&[0,1].map(i=>{const s=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});t.push(this.device.createFramebuffer({id:`deck-renderbuffer-${i}`,colorAttachments:[s]}))});for(const i of t)i.resize(e)}_postRender(t,e){const{renderBuffers:i}=this,s={...e,inputBuffer:i[0],swapBuffer:i[1]};for(const n of t)if(n.postRender){s.target=n.id===this.lastPostProcessEffect?e.target:void 0;const o=n.postRender(s);s.inputBuffer=o,s.swapBuffer=o===i[0]?i[1]:i[0]}}}const bn={pickedColor:null,pickedObjectIndex:-1};function Pn({pickedColors:r,decodePickingColor:t,deviceX:e,deviceY:i,deviceRadius:s,deviceRect:n}){const{x:o,y:a,width:h,height:c}=n;let l=s*s,u=-1,d=0;for(let p=0;p<c;p++){const f=p+a-i,g=f*f;if(g>l)d+=4*h;else for(let m=0;m<h;m++){if(r[d+3]-1>=0){const _=m+o-e,b=_*_+g;b<=l&&(l=b,u=d)}d+=4}}if(u>=0){const p=r.slice(u,u+4),f=t(p);if(f){const g=Math.floor(u/4/h),m=u/4-g*h;return{...f,pickedColor:p,pickedX:o+m,pickedY:a+g}}y.error("Picked non-existent layer. Is picking buffer corrupt?")()}return bn}function Sn({pickedColors:r,decodePickingColor:t}){const e=new Map;if(r){for(let i=0;i<r.length;i+=4)if(r[i+3]-1>=0){const n=r.slice(i,i+4),o=n.join(",");if(!e.has(o)){const a=t(n);a?e.set(o,{...a,color:n}):y.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(e.values())}function ye({pickInfo:r,viewports:t,pixelRatio:e,x:i,y:s,z:n}){let o=t[0];t.length>1&&(o=Tn(r?.pickedViewports||t,{x:i,y:s}));let a;if(o){const h=[i-o.x,s-o.y];n!==void 0&&(h[2]=n),a=o.unproject(h)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:i,y:s,pixel:[i,s],coordinate:a,devicePixel:r&&"pickedX"in r?[r.pickedX,r.pickedY]:void 0,pixelRatio:e}}function Mn(r){const{pickInfo:t,lastPickedInfo:e,mode:i,layers:s}=r,{pickedColor:n,pickedLayer:o,pickedObjectIndex:a}=t,h=o?[o]:[];if(i==="hover"){const u=e.index,d=e.layerId,p=o?o.props.id:null;if(p!==d||a!==u){if(p!==d){const f=s.find(g=>g.props.id===d);f&&h.unshift(f)}e.layerId=p,e.index=a,e.info=null}}const c=ye(r),l=new Map;return l.set(null,c),h.forEach(u=>{let d={...c};u===o&&(d.color=n,d.index=a,d.picked=!0),d=Ee({layer:u,info:d,mode:i});const p=d.layer;u===o&&i==="hover"&&(e.info=d),l.set(p.id,d),i==="hover"&&p.updateAutoHighlight(d)}),l}function Ee({layer:r,info:t,mode:e}){for(;r&&t;){const i=t.layer||null;t.sourceLayer=i,t.layer=r,t=r.getPickingInfo({info:t,mode:e,sourceLayer:i}),r=r.parent}return t}function Tn(r,t){for(let e=r.length-1;e>=0;e--){const i=r[e];if(i.containsPixel(t))return i}return r[0]}class Cn{constructor(t){this._pickable=!0,this.device=t,this.pickLayersPass=new le(t),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(t){"layerFilter"in t&&(this.layerFilter=t.layerFilter),"_pickable"in t&&(this._pickable=t._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(t){return this._pickClosestObject(t)}pickObjects(t){return this._pickVisibleObjects(t)}getLastPickedObject({x:t,y:e,layers:i,viewports:s},n=this.lastPickedInfo.info){const o=n&&n.layer&&n.layer.id,a=n&&n.viewport&&n.viewport.id,h=o?i.find(d=>d.id===o):null,c=a&&s.find(d=>d.id===a)||s[0],l=c&&c.unproject([t-c.x,e-c.y]);return{...n,...{x:t,y:e,viewport:c,coordinate:l,layer:h}}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const e=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=e}const{canvas:t}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:t.width,height:t.height}),this.depthFBO?.resize({width:t.width,height:t.height})}_getPickable(t){if(this._pickable===!1)return null;const e=t.filter(i=>this.pickLayersPass.shouldDrawLayer(i)&&!i.isComposite);return e.length?e:null}_pickClosestObject({layers:t,views:e,viewports:i,x:s,y:n,radius:o=0,depth:a=1,mode:h="query",unproject3D:c,onViewportActive:l,effects:u}){const d=this.device.canvasContext.cssToDeviceRatio(),p=this._getPickable(t);if(!p||i.length===0)return{result:[],emptyInfo:ye({viewports:i,x:s,y:n,pixelRatio:d})};this._resizeBuffer();const f=this.device.canvasContext.cssToDevicePixels([s,n],!0),g=[f.x+Math.floor(f.width/2),f.y+Math.floor(f.height/2)],m=Math.round(o*d),{width:w,height:_}=this.pickingFBO,b=this._getPickingRect({deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceWidth:w,deviceHeight:_}),T={x:s-o,y:n-o,width:o*2+1,height:o*2+1};let C;const D=[],x=new Set;for(let R=0;R<a;R++){let v;if(b){const P=this._drawAndSample({layers:p,views:e,viewports:i,onViewportActive:l,deviceRect:b,cullRect:T,effects:u,pass:`picking:${h}`});v=Pn({...P,deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceRect:b})}else v={pickedColor:null,pickedObjectIndex:-1};let V;if(v.pickedLayer&&c&&this.depthFBO){const{pickedColors:P}=this._drawAndSample({layers:[v.pickedLayer],views:e,viewports:i,onViewportActive:l,deviceRect:{x:v.pickedX,y:v.pickedY,width:1,height:1},cullRect:T,effects:u,pass:`picking:${h}:z`},!0);P[3]&&(V=P[0])}v.pickedLayer&&R+1<a&&(x.add(v.pickedLayer),v.pickedLayer.disablePickingIndex(v.pickedObjectIndex)),C=Mn({pickInfo:v,lastPickedInfo:this.lastPickedInfo,mode:h,layers:p,viewports:i,x:s,y:n,z:V,pixelRatio:d});for(const P of C.values())P.layer&&D.push(P);if(!v.pickedColor)break}for(const R of x)R.restorePickingColors();return{result:D,emptyInfo:C.get(null)}}_pickVisibleObjects({layers:t,views:e,viewports:i,x:s,y:n,width:o=1,height:a=1,mode:h="query",maxObjects:c=null,onViewportActive:l,effects:u}){const d=this._getPickable(t);if(!d||i.length===0)return[];this._resizeBuffer();const p=this.device.canvasContext.cssToDeviceRatio(),f=this.device.canvasContext.cssToDevicePixels([s,n],!0),g=f.x,m=f.y+f.height,w=this.device.canvasContext.cssToDevicePixels([s+o,n+a],!0),_=w.x+w.width,b=w.y,T={x:g,y:b,width:_-g,height:m-b},C=this._drawAndSample({layers:d,views:e,viewports:i,onViewportActive:l,deviceRect:T,cullRect:{x:s,y:n,width:o,height:a},effects:u,pass:`picking:${h}`}),D=Sn(C),x=new Map,R=[],v=Number.isFinite(c);for(let V=0;V<D.length&&!(v&&R.length>=c);V++){const P=D[V];let z={color:P.pickedColor,layer:null,index:P.pickedObjectIndex,picked:!0,x:s,y:n,pixelRatio:p};z=Ee({layer:P.pickedLayer,info:z,mode:h});const at=z.layer.id;x.has(at)||x.set(at,new Set);const Rt=x.get(at),xt=z.object??z.index;Rt.has(xt)||(Rt.add(xt),R.push(z))}return R}_drawAndSample({layers:t,views:e,viewports:i,onViewportActive:s,deviceRect:n,cullRect:o,effects:a,pass:h},c=!1){const l=c?this.depthFBO:this.pickingFBO,u={layers:t,layerFilter:this.layerFilter,views:e,viewports:i,onViewportActive:s,pickingFBO:l,deviceRect:n,cullRect:o,effects:a,pass:h,pickZ:c,preRenderStats:{},isPicking:!0};for(const _ of a)_.useInPicking&&(u.preRenderStats[_.id]=_.preRender(u));const{decodePickingColor:d}=this.pickLayersPass.render(u),{x:p,y:f,width:g,height:m}=n,w=new(c?Float32Array:Uint8Array)(g*m*4);return this.device.readPixelsToArrayWebGL(l,{sourceX:p,sourceY:f,sourceWidth:g,sourceHeight:m,target:w}),{pickedColors:w,decodePickingColor:d}}_getPickingRect({deviceX:t,deviceY:e,deviceRadius:i,deviceWidth:s,deviceHeight:n}){const o=Math.max(0,t-i),a=Math.max(0,e-i),h=Math.min(s,t+i+1)-o,c=Math.min(n,e+i+1)-a;return h<=0||c<=0?null:{x:o,y:a,width:h,height:c}}}const Rn={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},xn="top-left",Qt="__root";class Ln{constructor({deck:t,parentElement:e}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=t,this.parentElement=e}getWidgets(){return this.resolvedWidgets}setProps(t){t.widgets&&!q(t.widgets,this.widgets,1)&&this._setWidgets(t.widgets)}finalize(){for(const t of this.getWidgets())this._remove(t);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const t in this.containers)this.containers[t].remove()}addDefault(t){this.defaultWidgets.find(e=>e.id===t.id)||(this._add(t),this.defaultWidgets.push(t),this._setWidgets(this.widgets))}_setWidgets(t){const e={};for(const i of this.resolvedWidgets)e[i.id]=i;this.resolvedWidgets.length=0;for(const i of this.defaultWidgets)e[i.id]=null,this.resolvedWidgets.push(i);for(let i of t){const s=e[i.id];s?s.viewId!==i.viewId||s.placement!==i.placement?(this._remove(s),this._add(i)):i!==s&&(s.setProps(i.props),i=s):this._add(i),e[i.id]=null,this.resolvedWidgets.push(i)}for(const i in e){const s=e[i];s&&this._remove(s)}this.widgets=t}_add(t){const{viewId:e=null,placement:i=xn}=t,s=t.onAdd({deck:this.deck,viewId:e});s&&this._getContainer(e,i).append(s),t._element=s}_remove(t){t.onRemove?.(),t._element&&t._element.remove(),t._element=void 0}_getContainer(t,e){const i=t||Qt;let s=this.containers[i];s||(s=document.createElement("div"),s.style.pointerEvents="none",s.style.position="absolute",s.style.overflow="hidden",this.parentElement?.append(s),this.containers[i]=s);let n=s.querySelector(`.${e}`);return n||(n=document.createElement("div"),n.className=e,n.style.position="absolute",n.style.zIndex="2",Object.assign(n.style,Rn[e]),s.append(n)),n}_updateContainers(){const t=this.deck.width,e=this.deck.height;for(const i in this.containers){const s=this.lastViewports[i]||null,n=i===Qt||s,o=this.containers[i];n?(o.style.display="block",o.style.left=`${s?s.x:0}px`,o.style.top=`${s?s.y:0}px`,o.style.width=`${s?s.width:t}px`,o.style.height=`${s?s.height:e}px`):o.style.display="none"}}onRedraw({viewports:t,layers:e}){const i=t.reduce((s,n)=>(s[n.id]=n,s),{});for(const s of this.getWidgets()){const{viewId:n}=s;if(n){const o=i[n];o&&(s.onViewportChange&&s.onViewportChange(o),s.onRedraw?.({viewports:[o],layers:e}))}else{if(s.onViewportChange)for(const o of t)s.onViewportChange(o);s.onRedraw?.({viewports:t,layers:e})}}this.lastViewports=i,this._updateContainers()}onHover(t,e){for(const i of this.getWidgets()){const{viewId:s}=i;(!s||s===t.viewport?.id)&&i.onHover?.(t,e)}}onEvent(t,e){const i=pt[e.type];if(i)for(const s of this.getWidgets()){const{viewId:n}=s;(!n||n===t.viewport?.id)&&s[i]?.(t,e)}}}const kn={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class In{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:t}){const e=document.createElement("div");return e.className="deck-tooltip",Object.assign(e.style,kn),this.deck=t,this.element=e,e}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(t){this.isVisible&&t.id===this.lastViewport?.id&&t!==this.lastViewport&&this.setTooltip(null)}onHover(t){const{deck:e}=this,i=e&&e.props.getTooltip;if(!i)return;const s=i(t);this.lastViewport=t.viewport,this.setTooltip(s,t.x,t.y)}setTooltip(t,e,i){const s=this.element;if(s){if(typeof t=="string")s.innerText=t;else if(t)t.text&&(s.innerText=t.text),t.html&&(s.innerHTML=t.html),t.className&&(s.className=t.className);else{this.isVisible=!1,s.style.display="none";return}this.isVisible=!0,s.style.display="block",s.style.transform=`translate(${e}px, ${i}px)`,t&&typeof t=="object"&&"style"in t&&Object.assign(s.style,t.style)}}}const An={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},Dn=r=>({drawBuffersWEBGL(t){return r.drawBuffers(t)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),On=r=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return r.createVertexArray()},deleteVertexArrayOES(t){return r.deleteVertexArray(t)},isVertexArrayOES(t){return r.isVertexArray(t)},bindVertexArrayOES(t){return r.bindVertexArray(t)}}),Vn=r=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...t){return r.drawArraysInstanced(...t)},drawElementsInstancedANGLE(...t){return r.drawElementsInstanced(...t)},vertexAttribDivisorANGLE(...t){return r.vertexAttribDivisor(...t)}});function zn(r=!0){const t=HTMLCanvasElement.prototype;if(!r&&t.originalGetContext){t.getContext=t.originalGetContext,t.originalGetContext=void 0;return}t.originalGetContext=t.getContext,t.getContext=function(e,i){if(e==="webgl"||e==="experimental-webgl"){const s=this.originalGetContext("webgl2",i);return s instanceof HTMLElement&&Fn(s),s}return this.originalGetContext(e,i)}}function Fn(r){r.getExtension("EXT_color_buffer_float");const t={...An,WEBGL_disjoint_timer_query:r.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:Dn(r),OES_vertex_array_object:On(r),ANGLE_instanced_arrays:Vn(r)},e=r.getExtension;r.getExtension=function(s){const n=e.call(r,s);return n||(s in t?t[s]:null)};const i=r.getSupportedExtensions;r.getSupportedExtensions=function(){return(i.apply(r)||[])?.concat(Object.keys(t))}}const J=1;class Nn extends qi{type="webgl";constructor(){super(),et.defaultProps={...et.defaultProps,...ii},Y.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(t){zn(t)}async attach(t){if(t instanceof Y)return t;if(t?.device instanceof et)return t.device;if(!Un(t))throw new Error("Invalid WebGL2RenderingContext");return new Y({_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1}})}async create(t={}){E.groupCollapsed(J,"WebGLDevice created")();const e=[];(t.debugWebGL||t.debug)&&e.push(si()),t.debugSpectorJS&&e.push(ni(t));const i=await Promise.allSettled(e);for(const o of i)o.status==="rejected"&&E.error(`Failed to initialize debug libraries ${o.reason}`)();const s=new Y(t),n=`${s._reused?"Reusing":"Created"} device with WebGL2 ${s.debug?"debug ":""}context: ${s.info.vendor}, ${s.info.renderer} for canvas: ${s.canvasContext.id}`;return E.probe(J,n)(),E.table(J,s.info)(),E.groupEnd(J)(),s}}function Un(r){return typeof WebGL2RenderingContext<"u"&&r instanceof WebGL2RenderingContext?!0:!!(r&&Number.isFinite(r._version))}const te=new Nn;function A(){}const jn=({isDragging:r})=>r?"grabbing":"grab",be={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:A,onWebGLInitialized:A,onResize:A,onViewStateChange:A,onInteractionStateChange:A,onBeforeRender:A,onAfterRender:A,onLoad:A,onError:r=>y.error(r.message,r.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:jn,getTooltip:null,debug:!1,drawPickingColors:!1};class H{constructor(t){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new Pt({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=i=>{const{_pickRequest:s}=this;if(i.type==="pointerleave")s.x=-1,s.y=-1,s.radius=0;else{if(i.leftButton||i.rightButton)return;{const n=i.offsetCenter;if(!n)return;s.x=n.x,s.y=n.y,s.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:s.x,y:s.y}),s.event=i},this._onEvent=i=>{const s=pt[i.type],n=i.offsetCenter;if(!s||!n||!this.layerManager)return;const o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:o,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:h}=a,c=h&&(h[s]||h.props[s]),l=this.props[s];let u=!1;c&&(u=c.call(h,a,i)),u||(l?.(a,i),this.widgetManager.onEvent(a,i))},this._onPointerDown=i=>{if(this.device?.type==="webgpu")return;const s=i.offsetCenter,n=this._pick("pickObject","pickObject Time",{x:s.x,y:s.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=n.result[0]||n.emptyInfo},this.props={...be,...t},t=this.props,t.viewState&&t.initialViewState&&y.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,t.device&&(this.device=t.device);let e=this.device;!e&&t.gl&&(t.gl instanceof WebGLRenderingContext&&y.error("WebGL1 context not supported.")(),e=te.attach(t.gl)),e||(e=_t.createDevice({type:"best-available",_reuseDevices:!0,adapters:[te],...t.deviceProps,createCanvasContext:{canvas:this._createCanvas(t),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(e,t),this.setProps(t),t._typedArrayManagerProps&&Ne.setOptions(t._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(t){this.stats.get("setProps Time").timeStart(),"onLayerHover"in t&&y.removed("onLayerHover","onHover")(),"onLayerClick"in t&&y.removed("onLayerClick","onClick")(),t.initialViewState&&!q(this.props.initialViewState,t.initialViewState,3)&&(this.viewState=t.initialViewState),Object.assign(this.props,t),this._setCanvasSize(this.props);const e=Object.create(this.props);Object.assign(e,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop?.setProps(e),this.layerManager&&(this.viewManager.setProps(e),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(e),this.effectManager.setProps(e),this.deckRenderer.setProps(e),this.deckPicker.setProps(e),this.widgetManager.setProps(e)),this.stats.get("setProps Time").timeEnd()}needsRedraw(t={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);const i=this.viewManager.needsRedraw(t),s=this.layerManager.needsRedraw(t),n=this.effectManager.needsRedraw(t),o=this.deckRenderer.needsRedraw(t);return e=e||i||s||n||o,e}redraw(t){if(!this.layerManager)return;let e=this.needsRedraw({clearRedrawFlags:!0});e=t||e,e&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(e):this._drawLayers(e))}get isInitialized(){return this.viewManager!==null}getViews(){return S(this.viewManager),this.viewManager.views}getViewports(t){return S(this.viewManager),this.viewManager.getViewports(t)}getCanvas(){return this.canvas}pickObject(t){const e=this._pick("pickObject","pickObject Time",t).result;return e.length?e[0]:null}pickMultipleObjects(t){return t.depth=t.depth||10,this._pick("pickObject","pickMultipleObjects Time",t).result}pickObjects(t){return this._pick("pickObjects","pickObjects Time",t)}_addResources(t,e=!1){for(const i in t)this.layerManager.resourceManager.add({resourceId:i,data:t[i],forceUpdate:e})}_removeResources(t){for(const e of t)this.layerManager.resourceManager.remove(e)}_addDefaultEffect(t){this.effectManager.addDefaultEffect(t)}_addDefaultShaderModule(t){this.layerManager.addDefaultShaderModule(t)}_removeDefaultShaderModule(t){this.layerManager?.removeDefaultShaderModule(t)}_pick(t,e,i){S(this.deckPicker);const{stats:s}=this;s.get("Pick Count").incrementCount(),s.get(e).timeStart();const n=this.deckPicker[t]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return s.get(e).timeEnd(),n}_createCanvas(t){let e=t.canvas;return typeof e=="string"&&(e=document.getElementById(e),S(e)),e||(e=document.createElement("canvas"),e.id=t.id||"deckgl-overlay",(t.parent||document.body).appendChild(e)),Object.assign(e.style,t.style),e}_setCanvasSize(t){if(!this.canvas)return;const{width:e,height:i}=t;if(e||e===0){const s=Number.isFinite(e)?`${e}px`:e;this.canvas.style.width=s}if(i||i===0){const s=Number.isFinite(i)?`${i}px`:i;this.canvas.style.position=t.style?.position||"absolute",this.canvas.style.height=s}}_updateCanvasSize(){const{canvas:t}=this;if(!t)return;const e=t.clientWidth??t.width,i=t.clientHeight??t.height;(e!==this.width||i!==this.height)&&(this.width=e,this.height=i,this.viewManager?.setProps({width:e,height:i}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:e,height:i}))}_createAnimationLoop(t,e){const{gl:i,onError:s,useDevicePixels:n}=e;return new Ks({device:t,useDevicePixels:n,autoResizeDrawingBuffer:!i,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:s})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:t}=this.props,e=Array.isArray(t)?t:t?[t]:[new Tt({id:"default-view"})];return e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){const{onError:t}=this.props;this.animationLoop&&t&&t(new Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;const{_pickRequest:t}=this;if(t.event){const{result:e,emptyInfo:i}=this._pick("pickObject","pickObject Time",t);this.cursorState.isHovering=e.length>0;let s=i,n=!1;for(const o of e)s=o,n=o.layer?.onHover(o,t.event)||n;n||(this.props.onHover?.(s,t.event),this.widgetManager.onHover(s,t.event)),t.event=null}}_updateCursor(){const t=this.props.parent||this.canvas;t&&(t.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(t){if(this.device=t,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const e=new me;e.play(),this.animationLoop.attachTimeline(e),this.eventManager=new ms(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(zt).map(s=>{const[n,o,a,h]=zt[s],c=this.props.eventRecognizerOptions?.[s],l={...o,...c,event:s};return{recognizer:new n(l),recognizeWith:a,requestFailure:h}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const s in pt)this.eventManager.on(s,this._onEvent);this.viewManager=new nn({timeline:e,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const i=this.viewManager.getViewports()[0];this.layerManager=new sn(this.device,{deck:this,stats:this.stats,viewport:i,timeline:e}),this.effectManager=new _n({deck:this,device:this.device}),this.deckRenderer=new En(this.device),this.deckPicker=new Cn(this.device),this.widgetManager=new Ln({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new In),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(t,e){const{device:i,gl:s}=this.layerManager.context;this.props.onBeforeRender({device:i,gl:s});const n={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...e};this.deckRenderer?.renderLayers(n),n.pass==="screen"&&this.widgetManager.onRedraw({viewports:n.viewports,layers:n.layers}),this.props.onAfterRender({device:i,gl:s})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),y.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(t){const e=this.props.onViewStateChange(t)||t.viewState;this.viewState&&(this.viewState={...this.viewState,[t.viewId]:e},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(t){this.cursorState.isDragging=t.isDragging||!1,this.props.onInteractionStateChange(t)}_getFrameStats(){const{stats:t}=this;t.get("frameRate").timeEnd(),t.get("frameRate").timeStart();const e=this.animationLoop.stats;t.get("GPU Time").addTime(e.get("GPU Time").lastTiming),t.get("CPU Time").addTime(e.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:t,stats:e}=this;t.fps=e.get("frameRate").getHz(),t.setPropsTime=e.get("setProps Time").time,t.updateAttributesTime=e.get("Update Attributes").time,t.framesRedrawn=e.get("Redraw Count").count,t.pickTime=e.get("pickObject Time").time+e.get("pickMultipleObjects Time").time+e.get("pickObjects Time").time,t.pickCount=e.get("Pick Count").count,t.gpuTime=e.get("GPU Time").time,t.cpuTime=e.get("CPU Time").time,t.gpuTimePerFrame=e.get("GPU Time").getAverageTime(),t.cpuTimePerFrame=e.get("CPU Time").getAverageTime();const i=_t.stats.get("Memory Usage");t.bufferMemory=i.get("Buffer Memory").count,t.textureMemory=i.get("Texture Memory").count,t.renderbufferMemory=i.get("Renderbuffer Memory").count,t.gpuMemory=i.get("GPU Memory").count}}H.defaultProps=be;H.VERSION=Bi;const Q=Math.PI/180,ee=180/Math.PI,it=6370972,j=256;function Bn(){const r=j/it,t=Math.PI/180*j;return{unitsPerMeter:[r,r,r],unitsPerMeter2:[0,0,0],metersPerUnit:[1/r,1/r,1/r],unitsPerDegree:[t,t,r],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/t,1/t,1/r]}}class Gn extends ae{constructor(t={}){const{longitude:e=0,zoom:i=0,nearZMultiplier:s=.5,farZMultiplier:n=1,resolution:o=10}=t;let{latitude:a=0,height:h,altitude:c=1.5,fovy:l}=t;a=Math.max(Math.min(a,st),-st),h=h||1,l?c=Ue(l):l=je(c);const u=1/Math.PI/Math.cos(a*Math.PI/180),d=Math.pow(2,i)*u,p=t.nearZ??s,f=t.farZ??(c+j*2*d/h)*n,g=new ot().lookAt({eye:[0,-c,0],up:[0,0,1]});g.rotateX(a*Q),g.rotateZ(-e*Q),g.scale(d/h),super({...t,height:h,viewMatrix:g,longitude:e,latitude:a,zoom:i,distanceScales:Bn(),fovy:l,focalDistance:c,near:p,far:f}),this.scale=d,this.latitude=a,this.longitude=e,this.resolution=o}get projectionMode(){return re.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(t={}){const e={targetZ:t.z||0},i=this.unproject([0,this.height/2],e),s=this.unproject([this.width/2,0],e),n=this.unproject([this.width,this.height/2],e),o=this.unproject([this.width/2,this.height],e);return n[0]<this.longitude&&(n[0]+=360),i[0]>this.longitude&&(i[0]-=360),[Math.min(i[0],n[0],s[0],o[0]),Math.min(i[1],n[1],s[1],o[1]),Math.max(i[0],n[0],s[0],o[0]),Math.max(i[1],n[1],s[1],o[1])]}unproject(t,{topLeft:e=!0,targetZ:i}={}){const[s,n,o]=t,a=e?n:this.height-n,{pixelUnprojectionMatrix:h}=this;let c;if(Number.isFinite(o))c=lt(h,[s,a,o,1]);else{const p=lt(h,[s,a,-1,1]),f=lt(h,[s,a,1,1]),g=((i||0)/it+1)*j,m=ct(Be([],p,f)),w=ct(p),_=ct(f),T=4*((4*w*_-(m-w-_)**2)/16)/m,C=Math.sqrt(w-T),D=Math.sqrt(Math.max(0,g*g-T)),x=(C-D)/Math.sqrt(m);c=Ge([],p,f,x)}const[l,u,d]=this.unprojectPosition(c);return Number.isFinite(o)?[l,u,d]:Number.isFinite(i)?[l,u,i]:[l,u]}projectPosition(t){const[e,i,s=0]=t,n=e*Q,o=i*Q,a=Math.cos(o),h=(s/it+1)*j;return[Math.sin(n)*a*h,-Math.cos(n)*a*h,Math.sin(o)*h]}unprojectPosition(t){const[e,i,s]=t,n=We(t),o=Math.asin(s/n),h=Math.atan2(e,-i)*ee,c=o*ee,l=(n/j-1)*it;return[h,c,l]}projectFlat(t){return t}unprojectFlat(t){return t}panByPosition(t,e){const i=this.unproject(e);return{longitude:t[0]-i[0]+this.longitude,latitude:t[1]-i[1]+this.latitude}}}function lt(r,t){const e=He([],t,r);return Ze(e,e,1/e[3]),e}class Wn extends ve{applyConstraints(t){const{maxZoom:e,minZoom:i,zoom:s}=t;t.zoom=N(s,i,e);const{longitude:n,latitude:o}=t;return(n<-180||n>180)&&(t.longitude=qe(n+180,360)-180),t.latitude=N(o,-st,st),t}}class Hn extends _e{constructor(){super(...arguments),this.ControllerState=Wn,this.transition={transitionDuration:300,transitionInterpolator:new Mt(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(t){super.setProps(t),this.dragRotate=!1,this.touchRotate=!1}}class Pe extends we{constructor(t={}){super(t)}getViewportType(t){return t.zoom>12?he:Gn}get ControllerType(){return Hn}}Pe.displayName="GlobeView";const dt=512,Zn=Math.PI/180;function Se({map:r,gl:t,deck:e}){if(r.__deck)return r.__deck;const i=e?.props._customRender,s=e?.props.onLoad,n={...e?.props,_customRender:()=>{r.triggerRepaint(),i?.("")}};n.parameters={...Et(r,!0),...n.parameters},n.views||(n.views=nt(r));let o;return(!e||e.props.gl===t)&&(Object.assign(n,{gl:t,width:null,height:null,touchAction:"unset",viewState:Z(r)}),e?.isInitialized?ie(e,r):n.onLoad=()=>{s?.(),ie(o,r)}),e?(o=e,e.setProps(n),e.userData.isExternal=!0):(o=new H(n),r.on("remove",()=>{Me(r)})),o.userData.mapboxLayers=new Set,r.__deck=o,r.on("render",()=>{o.isInitialized&&Jn(o,r)}),o}function ie(r,t){const e=()=>{r.isInitialized?Qn(r,t):t.off("move",e)};t.on("move",e)}function Me(r){r.__deck?.finalize(),r.__deck=null}function Et(r,t){const e=t?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return Te(r)==="globe"&&(e.cullMode="back"),e}function qn(r,t){r.userData.mapboxLayers.add(t),Ct(r)}function $n(r,t){r.userData.mapboxLayers.delete(t),Ct(r)}function Xn(r,t){Ct(r)}function Yn(r,t,e,i){let{currentViewport:s}=r.userData,n=!1;s||(s=Ce(r,t,i),r.userData.currentViewport=s,n=!0),r.isInitialized&&r._drawLayers("mapbox-repaint",{viewports:[s],layerFilter:({layer:o})=>e.id===o.id||o.props.operation.includes("terrain"),clearStack:n,clearCanvas:!1})}function Te(r){const t=r.getProjection?.(),e=t?.type||t?.name;if(e==="globe")return"globe";if(e&&e!=="mercator")throw new Error("Unsupported projection");return"mercator"}function nt(r){return Te(r)==="globe"?new Pe({id:"mapbox"}):new Tt({id:"mapbox"})}function Z(r){const{lng:t,lat:e}=r.getCenter(),i={longitude:(t+540)%360-180,latitude:e,zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch(),padding:r.getPadding(),repeat:r.getRenderWorldCopies()};return r.getTerrain?.()&&Kn(r,i),i}function Kn(r,t){if(r.getFreeCameraOptions){const{position:e}=r.getFreeCameraOptions();if(!e||e.z===void 0)return;const i=r.transform.height,{longitude:s,latitude:n,pitch:o}=t,a=e.x*dt,h=(1-e.y)*dt,c=e.z*dt,l=$e([s,n]),u=a-l[0],d=h-l[1],p=Math.sqrt(u*u+d*d),f=o*Zn,g=1.5*i,m=f<.001?g*Math.cos(f)/c:g*Math.sin(f)/p;t.zoom=Math.log2(m);const w=g*Math.cos(f)/m,_=c-w;t.position=[0,0,_/Xe(n)]}else typeof r.transform.elevation=="number"&&(t.position=[0,0,r.transform.elevation])}function Ce(r,t,e){const i=Z(t),s=nt(t);e&&(s.props.nearZMultiplier=.2);const n=e?.nearZ??t.transform._nearZ,o=e?.farZ??t.transform._farZ;return Number.isFinite(n)&&(i.nearZ=n/t.transform.height,i.farZ=o/t.transform.height),s.makeViewport({width:r.width,height:r.height,viewState:i})}function Jn(r,t){const{mapboxLayers:e,isExternal:i}=r.userData;if(i){const s=Array.from(e,l=>l.id),o=W(r.props.layers,Boolean).some(l=>l&&!s.includes(l.id));let a=r.getViewports();const h=a.findIndex(l=>l.id==="mapbox"),c=a.length>1||h<0;(o||c)&&(h>=0&&(a=a.slice(),a[h]=Ce(r,t)),r._drawLayers("mapbox-repaint",{viewports:a,layerFilter:l=>(!r.props.layerFilter||r.props.layerFilter(l))&&(l.viewport.id!=="mapbox"||!s.includes(l.layer.id)),clearCanvas:!1}))}r.userData.currentViewport=null}function Qn(r,t){r.setProps({viewState:Z(t)}),r.needsRedraw({clearRedrawFlags:!0})}function Ct(r){if(r.userData.isExternal)return;const t=[];r.userData.mapboxLayers.forEach(e=>{const i=e.props.type,s=new i(e.props);t.push(s)}),r.setProps({layers:t})}class tr{constructor(t){if(!t.id)throw new Error("Layer must have an unique id");this.id=t.id,this.type="custom",this.renderingMode=t.renderingMode||"3d",this.slot=t.slot,this.map=null,this.deck=null,this.props=t}onAdd(t,e){this.map=t,this.deck=Se({map:t,gl:e,deck:this.props.deck}),qn(this.deck,this)}onRemove(){this.deck&&$n(this.deck,this)}setProps(t){Object.assign(this.props,t,{id:this.id}),this.deck&&Xn(this.deck)}render(t,e){Yn(this.deck,this.map,this,e)}}const ut="__UNDEFINED__";function tt(r,t,e,i){if(!r||!t||!r.style||!r.style._loaded)return;const s=W(i,Boolean);if(e!==i){const a=W(e,Boolean),h=new Set(a.map(c=>c.id));for(const c of s)h.delete(c.id);for(const c of h)r.getLayer(c)&&r.removeLayer(c)}for(const a of s){const h=r.getLayer(a.id);h?(h.implementation||h).setProps(a.props):r.addLayer(new tr({id:a.id,deck:t,slot:a.props.slot}),a.props.beforeId)}const n=r.style._order,o={};for(const a of s){let{beforeId:h}=a.props;(!h||!n.includes(h))&&(h=ut),o[h]=o[h]||[],o[h].push(a.id)}for(const a in o){const h=o[a];let c=a===ut?n.length:n.indexOf(a),l=a===ut?void 0:a;for(let u=h.length-1;u>=0;u--){const d=h[u],p=n.indexOf(d);p!==c-1&&(r.moveLayer(d,l),p>c&&c++),c--,l=d}}}class nr{constructor(t){this._handleStyleChange=()=>{tt(this._map,this._deck,this._props.layers,this._props.layers)},this._updateContainerSize=()=>{if(this._map&&this._container){const{clientWidth:s,clientHeight:n}=this._map.getContainer();Object.assign(this._container.style,{width:`${s}px`,height:`${n}px`})}},this._updateViewState=()=>{const s=this._deck,n=this._map;s&&n&&(s.setProps({views:this._props.views||nt(n),viewState:Z(n)}),s.isInitialized&&s.redraw())},this._handleMouseEvent=s=>{const n=this._deck;if(!n||!n.isInitialized)return;const o={type:s.type,offsetCenter:s.point,srcEvent:s},a=this._lastMouseDownPoint;switch(!s.point&&a&&(o.deltaX=s.originalEvent.clientX-a.clientX,o.deltaY=s.originalEvent.clientY-a.clientY,o.offsetCenter={x:a.x+o.deltaX,y:a.y+o.deltaY}),o.type){case"mousedown":n._onPointerDown(o),this._lastMouseDownPoint={...s.point,clientX:s.originalEvent.clientX,clientY:s.originalEvent.clientY};break;case"dragstart":o.type="panstart",n._onEvent(o);break;case"drag":o.type="panmove",n._onEvent(o);break;case"dragend":o.type="panend",n._onEvent(o);break;case"click":o.tapCount=1,n._onEvent(o);break;case"dblclick":o.type="click",o.tapCount=2,n._onEvent(o);break;case"mousemove":o.type="pointermove",n._onPointerMove(o);break;case"mouseout":o.type="pointerleave",n._onPointerMove(o);break;default:return}};const{interleaved:e=!1,...i}=t;this._interleaved=e,this._props=i}setProps(t){this._interleaved&&t.layers&&tt(this._map,this._deck,this._props.layers,t.layers),Object.assign(this._props,t),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...Et(this._map,this._interleaved),...this._props.parameters}})}onAdd(t){return this._map=t,this._interleaved?this._onAddInterleaved(t):this._onAddOverlaid(t)}_onAddOverlaid(t){const e=document.createElement("div");return Object.assign(e.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=e,this._deck=new H({...this._props,parent:e,parameters:{...Et(t,!1),...this._props.parameters},views:this._props.views||nt(t),viewState:Z(t)}),t.on("resize",this._updateContainerSize),t.on("render",this._updateViewState),t.on("mousedown",this._handleMouseEvent),t.on("dragstart",this._handleMouseEvent),t.on("drag",this._handleMouseEvent),t.on("dragend",this._handleMouseEvent),t.on("mousemove",this._handleMouseEvent),t.on("mouseout",this._handleMouseEvent),t.on("click",this._handleMouseEvent),t.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),e}_onAddInterleaved(t){const e=t.painter.context.gl;return e instanceof WebGLRenderingContext&&y.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=Se({map:t,gl:e,deck:new H({...this._props,gl:e})}),t.on("styledata",this._handleStyleChange),tt(t,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){const t=this._map;t&&(this._interleaved?this._onRemoveInterleaved(t):this._onRemoveOverlaid(t)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(t){t.off("resize",this._updateContainerSize),t.off("render",this._updateViewState),t.off("mousedown",this._handleMouseEvent),t.off("dragstart",this._handleMouseEvent),t.off("drag",this._handleMouseEvent),t.off("dragend",this._handleMouseEvent),t.off("mousemove",this._handleMouseEvent),t.off("mouseout",this._handleMouseEvent),t.off("click",this._handleMouseEvent),t.off("dblclick",this._handleMouseEvent),this._deck?.finalize()}_onRemoveInterleaved(t){t.off("styledata",this._handleStyleChange),tt(t,this._deck,this._props.layers,[]),Me(t)}getDefaultPosition(){return"top-left"}pickObject(t){return S(this._deck),this._deck.pickObject(t)}pickMultipleObjects(t){return S(this._deck),this._deck.pickMultipleObjects(t)}pickObjects(t){return S(this._deck),this._deck.pickObjects(t)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}}export{nr as MapboxOverlay};
